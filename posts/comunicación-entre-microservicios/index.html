<!DOCTYPE html><html lang="es-ES" data-mode="dark" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="Microservicios 3 Comunicación entre microservicios" /><meta name="author" content="Benjamin" /><meta property="og:locale" content="es_ES" /><meta name="description" content="Ingeniería de software aplicada, tips, buenas práctias y códigos" /><meta property="og:description" content="Ingeniería de software aplicada, tips, buenas práctias y códigos" /><link rel="canonical" href="https://nullpointer-excelsior.github.io/posts/comunicaci%C3%B3n-entre-microservicios/" /><meta property="og:url" content="https://nullpointer-excelsior.github.io/posts/comunicaci%C3%B3n-entre-microservicios/" /><meta property="og:site_name" content="Nullpointer Excelsior" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2023-12-13T02:00:00-03:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Microservicios 3 Comunicación entre microservicios" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Benjamin"},"dateModified":"2023-12-13T02:00:00-03:00","datePublished":"2023-12-13T02:00:00-03:00","description":"Ingeniería de software aplicada, tips, buenas práctias y códigos","headline":"Microservicios 3 Comunicación entre microservicios","mainEntityOfPage":{"@type":"WebPage","@id":"https://nullpointer-excelsior.github.io/posts/comunicaci%C3%B3n-entre-microservicios/"},"url":"https://nullpointer-excelsior.github.io/posts/comunicaci%C3%B3n-entre-microservicios/"}</script><title>Microservicios 3 Comunicación entre microservicios | Nullpointer Excelsior</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Nullpointer Excelsior"><meta name="application-name" content="Nullpointer Excelsior"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" class="mx-auto"> <img src="/assets/img/avatar.webp" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Nullpointer Excelsior</a></div><div class="site-subtitle font-italic">Ingeniería de software aplicada</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>INICIO</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORÍAS</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>ETIQUETAS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVO</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ACERCA DE</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <a href="https://github.com/nullpointer-excelsior" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a></div></div><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4"> <span id="breadcrumb"> <span> <a href="/"> Inicio </a> </span> <span>Microservicios 3 Comunicación entre microservicios</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Entrada</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Buscar..."> </span> <span id="search-cancel" >Cancelar</span></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container pl-xl-4 pr-xl-4"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4"><div class="post pl-1 pr-1 pl-md-2 pr-md-2"><h1 data-toc-skip>Microservicios 3 Comunicación entre microservicios</h1><div class="post-meta text-muted"> <span> Publicado <em class="" data-ts="1702443600" data-df="YYYY-MM-DD" data-toggle="tooltip" data-placement="bottom"> 2023-12-13 </em> </span><div class="d-flex justify-content-between"> <span> Por <em> Benjamin </em> </span><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="2391 palabras"> <em>13 min</em> de lectura</span></div></div></div><div class="post-content"><p><img data-src="https://i.ibb.co/brTPgV5/Screenshot-2023-12-14-at-13-15-20.png" alt="intro" data-proofer-ignore></p><p>En arquitecturas orientadas a microservicios, contamos con numerosos componentes, aplicaciones y sistemas encargados de realizar tareas y procesos. Cada tarea o proceso puede recibir una entrada, procesarla y generar una salida. A su vez, esta salida puede ser devuelta o asignada a otro componente. Para lograr orquestar estos procesos se utilizan los protocolos de comunicación. En las arquitecturas de microservicios y en los sistemas distribuidos, la comunicación desempeña un papel crucial. Sin ella, estos sistemas no existirían. En este artículo exploraremos cómo funcionan las comunicaciones en aplicaciones basadas en microservicios.</p><h2 id="qué-son-los-protocolos"><span class="mr-2">¿Qué son los protocolos?</span><a href="#qué-son-los-protocolos" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Los protocolos básicamente nos indican cómo los sistemas deben comunicarse entre sí. Definimos un formato de petición y un formato de respuesta con el cual podremos comunicar dos sistemas de una manera estandarizada. Estas pautas son descritas en documentos llamados RFC. La mayoría del tiempo, para nosotros, los protocolos son algo más ligado al bajo nivel. Ahora tenemos librerías y tecnologías que trabajan con estos con mayor abstracción y así podemos desarrollar soluciones con mayor facilidad.</p><p>Sin embargo, no está de más recordar estos conceptos fundamentales en el mundo de los microservicios, ya que existen un montón de arquitecturas y tecnologías involucradas en sistemas más complejos. Saber qué pasa por debajo de una librería o tecnología nos ayudará a resolver problemas que van más allá del código, los cuales la mayor parte del tiempo son los más difíciles de encontrar.</p><p>Actualmente, una forma de comunicar dos aplicaciones es mediante RESTful, un enfoque popular y súper simple de implementar que por debajo usa HTTP. RESTful no es la única manera en que dos aplicaciones pueden comunicarse. A continuación, hablaremos de las distintas maneras que tenemos disponibles en arquitecturas orientadas a microservicios para la comunicación de aplicaciones.</p><h2 id="tipos-de-comunicación-entre-microservicios"><span class="mr-2">Tipos de comunicación entre microservicios</span><a href="#tipos-de-comunicación-entre-microservicios" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Los microservicios, al ser aplicaciones independientes con necesidad de comunicarse con otras aplicaciones, tendremos disponibles básicamente dos categorías de comunicación síncronas y asíncronas.</p><h3 id="comunicación-síncrona"><span class="mr-2">Comunicación síncrona</span><a href="#comunicación-síncrona" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>En la comunicación síncrona, un microservicio espera una respuesta inmediata después de enviar una solicitud a otro microservicio. Esto se asemeja a una conversación en tiempo real, donde el microservicio solicitante detiene su ejecución y espera la respuesta antes de continuar. Dentro de este enfoque tenemos a RESTful, GraphQL o Remote Call Procedures (RPC).</p><h3 id="comunicación-asíncrona"><span class="mr-2">Comunicación asíncrona</span><a href="#comunicación-asíncrona" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>En la comunicación asíncrona, los microservicios envían mensajes sin esperar una respuesta inmediata. Esto se asemeja a dejar una nota para alguien, donde no hay una interacción directa en tiempo real. Los sistemas de mensajería como RabbitMQ, Apache Kafka o Amazon SQS se utilizan comúnmente para la comunicación asíncrona entre aplicaciones.</p><h2 id="cuándo-usar-asíncrono-vs-síncrono"><span class="mr-2">¿Cuándo usar asíncrono vs síncrono?</span><a href="#cuándo-usar-asíncrono-vs-síncrono" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>La elección entre comunicación síncrona y asíncrona en microservicios depende de varios factores, y cada enfoque tiene sus propias fortalezas dependiendo del contexto. Básicamente, podemos tomar las siguientes consideraciones:</p><ul><li><p>Comunicación síncrona: Usa esto cuando necesites una respuesta inmediata para continuar con una tarea específica o cuando la consistencia de los datos sea crucial.</p><li><p>Comunicación asíncrona: Opta por esto cuando busques escalabilidad, desacoplamiento entre microservicios o cuando necesites procesar tareas en segundo plano sin bloquear otras operaciones.</p></ul><p>En la práctica, a menudo es útil una combinación de ambos enfoques para diferentes casos o situaciones. A continuación, se detallan las ventajas y desventajas de ambos enfoques.</p><h3 id="ventajas-de-la-comunicación-asíncrona"><span class="mr-2">Ventajas de la comunicación asíncrona:</span><a href="#ventajas-de-la-comunicación-asíncrona" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li>Permite la desacoplación entre microservicios, lo que significa que pueden funcionar de forma independiente.<li>Mayor escalabilidad ya que los microservicios no están esperando respuestas.<li>Mejor tolerancia a fallos, ya que un microservicio puede seguir funcionando aunque el receptor esté temporalmente inactivo.</ul><h3 id="desventajas-de-la-comunicación-asíncrona"><span class="mr-2">Desventajas de la comunicación asíncrona:</span><a href="#desventajas-de-la-comunicación-asíncrona" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li>Puede ser más complejo de diseñar y mantener, ya que los sistemas deben gestionar la llegada y el procesamiento de mensajes de manera independiente.<li>La gestión de errores puede ser más complicada debido a la falta de respuesta inmediata.</ul><h3 id="ventajas-de-la-comunicación-síncrona"><span class="mr-2">Ventajas de la comunicación síncrona:</span><a href="#ventajas-de-la-comunicación-síncrona" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li>Simplifica el manejo de errores y excepciones.<li>Es más fácil de entender y depurar, ya que el flujo de control es lineal y directo.</ul><h3 id="desventajas-de-la-comunicación-síncrona"><span class="mr-2">Desventajas de la comunicación síncrona:</span><a href="#desventajas-de-la-comunicación-síncrona" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li>Puede aumentar la latencia, ya que el microservicio solicitante debe esperar la respuesta.<li>La sobrecarga de red puede ser un problema si hay muchas solicitudes simultáneas.<li>Si un microservicio está inactivo o es lento, puede afectar a los demás que dependen de él.</ul><h2 id="ejemplo-de-comunicación-síncrona"><span class="mr-2">Ejemplo de comunicación síncrona</span><a href="#ejemplo-de-comunicación-síncrona" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Crearemos un pequeño ejemplo de un cliente HTTP con NestJS, basándonos en nuestra arquitectura de <strong>Spotify-Clone</strong>.</p><h3 id="creando-un-cliente-http-reutilizable"><span class="mr-2">Creando un cliente HTTP reutilizable</span><a href="#creando-un-cliente-http-reutilizable" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>El siguiente código ejemplifica el uso de <code class="language-plaintext highlighter-rouge">HttpModule</code> en NestJS. Esto nos permite establecer propiedades de manera global para el cliente HTTP. Esta aproximación nos brinda la oportunidad de configurar nuestro cliente HTTP de forma única, evitando repeticiones.</p><div class="language-typescript highlighter-rouge"><div class="code-header"> <span data-label-text="TypeScript"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="¡Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre><span class="c1">// ejemplo básico de uso de HttpModule</span>
<span class="p">@</span><span class="nd">Module</span><span class="p">({</span>
  <span class="na">imports</span><span class="p">:</span> <span class="p">[</span>
    <span class="nx">HttpModule</span><span class="p">.</span><span class="nx">register</span><span class="p">({</span>
      <span class="na">baseURL</span><span class="p">:</span> <span class="dl">'</span><span class="s1">http://localhost:3000/api-url</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">timeout</span><span class="p">:</span> <span class="mi">5000</span><span class="p">,</span>
      <span class="na">maxRedirects</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
    <span class="p">}),</span>
  <span class="p">],</span>
  <span class="na">providers</span><span class="p">:</span> <span class="p">[</span><span class="nx">MusicLibraryClient</span><span class="p">],</span>
<span class="p">})</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">MusicLibraryModule</span> <span class="p">{}</span>

</pre></table></code></div></div><p>Ahora crearemos un servicio llamado <code class="language-plaintext highlighter-rouge">MusicLibraryClient</code>, el cual será el cliente HTTP del microservicio <code class="language-plaintext highlighter-rouge">music-library</code>. Este microservicio es el encargado de obtener información sobre artistas, álbumes y canciones de <strong>Spotify-Clone</strong>.</p><div class="language-typescript highlighter-rouge"><div class="code-header"> <span data-label-text="TypeScript"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="¡Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
</pre><td class="rouge-code"><pre><span class="c1">// Definimos una clase de Error para evitar la verbosidad de un AxiosError al momento de realizar un catch</span>
<span class="kd">type</span> <span class="nx">Props</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">message</span><span class="p">:</span> <span class="kr">string</span><span class="p">;</span>
    <span class="nl">status</span><span class="p">:</span> <span class="kr">number</span><span class="p">;</span>
    <span class="nl">response</span><span class="p">:</span> <span class="kr">string</span><span class="p">;</span>
    <span class="nl">url</span><span class="p">:</span> <span class="kr">string</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">export</span> <span class="kd">class</span> <span class="nx">HttpClientError</span> <span class="kd">extends</span> <span class="nb">Error</span> <span class="p">{</span>
    
    <span class="k">public</span> <span class="k">readonly</span> <span class="nx">status</span><span class="p">:</span> <span class="kr">number</span><span class="p">;</span>
    <span class="k">public</span> <span class="k">readonly</span> <span class="nx">response</span><span class="p">:</span> <span class="kr">string</span><span class="p">;</span>
    <span class="k">public</span> <span class="k">readonly</span> <span class="nx">url</span><span class="p">:</span> <span class="kr">string</span><span class="p">;</span>

    <span class="kd">constructor</span><span class="p">({</span> <span class="nx">message</span><span class="p">,</span> <span class="na">status</span><span class="p">:</span> <span class="nx">statusResponse</span><span class="p">,</span> <span class="na">response</span><span class="p">:</span> <span class="nx">textResponse</span><span class="p">,</span> <span class="nx">url</span> <span class="p">}:</span> <span class="nx">Props</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">super</span><span class="p">(</span><span class="nx">message</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="kd">constructor</span><span class="p">.</span><span class="nx">name</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">status</span> <span class="o">=</span> <span class="nx">statusResponse</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">response</span> <span class="o">=</span> <span class="nx">textResponse</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">url</span> <span class="o">=</span> <span class="nx">url</span><span class="p">;</span>
        <span class="nb">Object</span><span class="p">.</span><span class="nx">setPrototypeOf</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">HttpClientError</span><span class="p">.</span><span class="nx">prototype</span><span class="p">);</span>
      <span class="p">}</span>

<span class="p">}</span>

<span class="c1">// Definimos nuestro cliente reutilizable</span>
<span class="p">@</span><span class="nd">Injectable</span><span class="p">()</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">HttpClient</span> <span class="p">{</span>

    <span class="kd">constructor</span><span class="p">(</span><span class="k">private</span> <span class="k">readonly</span> <span class="nx">http</span><span class="p">:</span> <span class="nx">HttpService</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>

    <span class="kd">get</span><span class="o">&lt;</span><span class="nx">T</span> <span class="o">=</span> <span class="kr">any</span><span class="o">&gt;</span><span class="p">(</span><span class="nx">endpoint</span><span class="p">:</span> <span class="kr">string</span><span class="p">,</span> <span class="nx">config</span><span class="p">?:</span> <span class="nx">AxiosRequestConfig</span><span class="p">):</span> <span class="nx">Observable</span><span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;</span> <span class="p">{</span>
        <span class="kd">const</span> <span class="nx">url</span> <span class="o">=</span> <span class="s2">`/</span><span class="p">${</span><span class="nx">endpoint</span><span class="p">}</span><span class="s2">`</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">http</span><span class="p">.</span><span class="kd">get</span><span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="nx">config</span><span class="p">).</span><span class="nx">pipe</span><span class="p">(</span>
            <span class="nx">map</span><span class="p">(</span><span class="nx">res</span> <span class="o">=&gt;</span> <span class="nx">res</span><span class="p">.</span><span class="nx">data</span><span class="p">),</span>
            <span class="nx">catchError</span><span class="p">((</span><span class="nx">error</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">isAxiosError</span><span class="p">(</span><span class="nx">error</span><span class="p">))</span> <span class="p">{</span>
                    <span class="k">throw</span> <span class="k">new</span> <span class="nx">HttpClientError</span><span class="p">({</span> 
                        <span class="na">message</span><span class="p">:</span> <span class="nx">error</span><span class="p">.</span><span class="nx">message</span><span class="p">,</span>
                        <span class="na">status</span><span class="p">:</span> <span class="nx">error</span><span class="p">.</span><span class="nx">response</span><span class="p">?.</span><span class="nx">status</span> <span class="o">||</span> <span class="mi">500</span><span class="p">,</span>
                        <span class="na">url</span><span class="p">:</span> <span class="nx">error</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">url</span> <span class="o">||</span> <span class="dl">""</span><span class="p">,</span>
                        <span class="na">response</span><span class="p">:</span> <span class="nx">error</span><span class="p">.</span><span class="nx">response</span><span class="p">?.</span><span class="nx">data</span> <span class="o">||</span> <span class="dl">'</span><span class="s1">Unknown error</span><span class="dl">'</span><span class="p">,</span>
                     <span class="p">})</span>
                <span class="p">}</span>
                <span class="k">throw</span> <span class="nx">error</span>
            <span class="p">})</span>
        <span class="p">);</span>
    <span class="p">}</span>

<span class="p">}</span> 

<span class="c1">// definimos nuestro modulo personalizado para ser usado con aplicaciones basadas en NestJS</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">Module</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">@nestjs/common</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">HttpClient</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">./client/http-client</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">HttpModule</span><span class="p">,</span> <span class="nx">HttpModuleAsyncOptions</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">@nestjs/axios</span><span class="dl">'</span><span class="p">;</span>

<span class="p">@</span><span class="nd">Module</span><span class="p">({</span>
<span class="p">})</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">HttpClientModule</span> <span class="p">{</span>
    
    <span class="k">static</span> <span class="nx">registerAsync</span><span class="p">(</span><span class="nx">options</span><span class="p">:</span> <span class="nx">HttpModuleAsyncOptions</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="na">module</span><span class="p">:</span> <span class="nx">HttpClientModule</span><span class="p">,</span>
            <span class="na">imports</span><span class="p">:</span> <span class="p">[</span>
                <span class="nx">HttpModule</span><span class="p">.</span><span class="nx">registerAsync</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span>
            <span class="p">],</span>
            <span class="na">providers</span><span class="p">:</span> <span class="p">[</span>
                <span class="nx">HttpClient</span>
            <span class="p">],</span>
            <span class="na">exports</span><span class="p">:</span> <span class="p">[</span>
                <span class="nx">HttpClient</span>
            <span class="p">]</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Y utilizamos nuestro componente en clases de tipo servicio.</p><div class="language-typescript highlighter-rouge"><div class="code-header"> <span data-label-text="TypeScript"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="¡Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre><span class="p">@</span><span class="nd">Injectable</span><span class="p">()</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">ArtistAPI</span> <span class="p">{</span>

  <span class="kd">constructor</span><span class="p">(</span><span class="k">private</span> <span class="nx">client</span><span class="p">:</span> <span class="nx">MusicLibraryClient</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>

  <span class="nx">findById</span><span class="p">(</span><span class="nx">id</span><span class="p">:</span> <span class="kr">string</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">client</span><span class="p">.</span><span class="kd">get</span><span class="o">&lt;</span><span class="nx">Artist</span><span class="o">&gt;</span><span class="p">(</span><span class="s2">`artists/</span><span class="p">${</span><span class="nx">id</span><span class="p">}</span><span class="s2">`</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="nx">findAll</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">client</span><span class="p">.</span><span class="kd">get</span><span class="o">&lt;</span><span class="nx">Artist</span><span class="p">[]</span><span class="o">&gt;</span><span class="p">(</span><span class="s2">`artists`</span><span class="p">)</span>
  <span class="p">}</span>

<span class="p">}</span>
</pre></table></code></div></div><p>Este enfoque de cliente tiene las siguientes ventajas:</p><ul><li>Toda lógica ligada a HTTP está centralizada en nuestro componente <code class="language-plaintext highlighter-rouge">HttpClient</code>.<li>Encapsulamos toda la lógica de la librería Axios dentro de nuestro cliente, evitando así acoplarnos a una solución en específico.<li>Las clases que usen el cliente podrán crear dominios más desacoplados.</ul><h2 id="ejemplo-de-comunicación-asíncrona"><span class="mr-2">Ejemplo de comunicación asíncrona</span><a href="#ejemplo-de-comunicación-asíncrona" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Ahora crearemos un ejemplo de comunicación asíncrona con el siguiente caso de uso, basado en la arquitectura de nuestro <strong>Spotify-Clone</strong>:</p><p>Cuando se crea un nuevo álbum de un artista, debemos enviar un correo electrónico de notificación a los usuarios que estén interesados en las noticias del artista.</p><p>Para lograr esto, lo haremos mediante una cola de mensajería. Esta cola básicamente recibe mensajes de aplicaciones productoras y estos mensajes serán escuchados por aplicaciones suscriptoras. Cada aplicación suscriptora podrá realizar alguna operación o tarea con la información contenida en el mensaje.</p><h3 id="ejemplo-básico-de-mensajería-con-rabbitmq"><span class="mr-2">Ejemplo básico de mensajería con RabbitMQ.</span><a href="#ejemplo-básico-de-mensajería-con-rabbitmq" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Crearemos un ejemplo con RabbitMQ, el cual es un servicio de colas de mensajería. Para levantarlo, debemos hacer uso de <code class="language-plaintext highlighter-rouge">docker-compose</code>.</p><div class="language-yml highlighter-rouge"><div class="code-header"> <span data-label-text="YAML"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="¡Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre><span class="na">version</span><span class="pi">:</span> <span class="s1">'</span><span class="s">3'</span>

<span class="na">services</span><span class="pi">:</span>
  <span class="na">rabbitmq</span><span class="pi">:</span>
    <span class="na">container_name</span><span class="pi">:</span> <span class="s">rabbitmq</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">rabbitmq:3-management-alpine</span>
    <span class="na">ports</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s">5672:5672</span>
        <span class="pi">-</span> <span class="s">15672:15672</span>
    <span class="na">environment</span><span class="pi">:</span>
      <span class="na">RABBITMQ_DEFAULT_USER</span><span class="pi">:</span> <span class="s">${RABBITMQ_USER}</span>
      <span class="na">RABBITMQ_DEFAULT_PASS</span><span class="pi">:</span> <span class="s">${RABBITMQ_PASS}</span>
    <span class="na">networks</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">microservices-architecture</span>

</pre></table></code></div></div><p>NestJS nos provee un módulo de <a href="https://docs.nestjs.com/microservices/rabbitmq">RabbitMQ</a> con el que podremos implementar los casos de uso más comunes.</p><blockquote><p>Si no conoces nada sobre RabbitMQ, te recomiendo que leas este post que profundiza más en detalle: <a href="https://nullpointer-excelsior.github.io/posts/mono-repo-with-nestjs/">Enlace</a>.</p></blockquote><p>Ahora simularemos un microservicio que envía correos. Este servicio estará escuchando los mensajes que se reciban en la cola <code class="language-plaintext highlighter-rouge">spotify-clone</code> y dependiendo del tipo de mensaje, enviará un correo electrónico.</p><div class="language-typescript highlighter-rouge"><div class="code-header"> <span data-label-text="TypeScript"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="¡Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
</pre><td class="rouge-code"><pre><span class="c1">// Definimos el RabbitMqModule con la configuración de RabbitMQ</span>
<span class="p">@</span><span class="nd">Module</span><span class="p">({</span>
    <span class="c1">// ... module configuration</span>
<span class="p">})</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">RabbitmqQueueModule</span> <span class="p">{</span>

    <span class="k">static</span> <span class="nx">getMicroserviceOptions</span><span class="p">():</span> <span class="kr">any</span> <span class="p">{</span>

        <span class="kd">const</span> <span class="nx">user</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">RABBITMQ_USER</span>
        <span class="kd">const</span> <span class="nx">password</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">RABBITMQ_PASS</span>
        <span class="kd">const</span> <span class="nx">host</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">RABBITMQ_HOST</span>
        <span class="kd">const</span> <span class="nx">amqpurl</span> <span class="o">=</span> <span class="s2">`amqp://</span><span class="p">${</span><span class="nx">user</span><span class="p">}</span><span class="s2">:</span><span class="p">${</span><span class="nx">password</span><span class="p">}</span><span class="s2">@</span><span class="p">${</span><span class="nx">host</span><span class="p">}</span><span class="s2">:5672`</span>
    
        <span class="k">return</span> <span class="p">{</span>
            <span class="na">transport</span><span class="p">:</span> <span class="nx">Transport</span><span class="p">.</span><span class="nx">RMQ</span><span class="p">,</span>
            <span class="na">options</span><span class="p">:</span> <span class="p">{</span>
                <span class="na">urls</span><span class="p">:</span> <span class="p">[</span>
                    <span class="nx">amqpurl</span>
                <span class="p">],</span>
                <span class="na">queue</span><span class="p">:</span> <span class="nx">QUEUE_NAME</span><span class="p">,</span>
                <span class="na">queueOptions</span><span class="p">:</span> <span class="p">{</span>
                    <span class="na">durable</span><span class="p">:</span> <span class="kc">false</span>
                <span class="p">},</span>
            <span class="p">}</span>
        <span class="p">}</span>

    <span class="p">}</span>

<span class="p">}</span>

<span class="c1">// Iniciamos un microservicio de NestJs en main.ts</span>
<span class="k">async</span> <span class="kd">function</span> <span class="nx">bootstrap</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">NestFactory</span><span class="p">.</span><span class="nx">createMicroservice</span><span class="p">(</span>
    <span class="nx">MailingMsModule</span><span class="p">,</span>
    <span class="nx">RabbitmqQueueModule</span><span class="p">.</span><span class="nx">getMicroserviceOptions</span><span class="p">()</span>
  <span class="p">);</span>
  <span class="k">await</span> <span class="nx">app</span><span class="p">.</span><span class="nx">listen</span><span class="p">();</span>
<span class="p">}</span>

</pre></table></code></div></div><p>Una vez levantado nuestro microservicio con RabbitMQ, se creará una cola en el servidor de RabbitMQ la cual estará lista para recibir mensajes. En este ejemplo, los mensajes de nuevos álbumes creados serán recibidos por medio de los clásicos controladores de NestJS. En este caso, ya no se utilizan para una API REST, sino que NestJS los transformará automáticamente para RabbitMQ.</p><p>Para que podamos escuchar mensajes lo haremos mediante la anotación <code class="language-plaintext highlighter-rouge">@MessagePattern('EVENT_NAME')</code> en la cual especificamos el patrón de mensajes que queremos escuchar.</p><div class="language-typescript highlighter-rouge"><div class="code-header"> <span data-label-text="TypeScript"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="¡Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="p">@</span><span class="nd">Controller</span><span class="p">()</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">QueueController</span> <span class="p">{</span>
  
  <span class="kd">constructor</span><span class="p">(</span><span class="k">private</span> <span class="k">readonly</span> <span class="nx">email</span><span class="p">:</span> <span class="nx">EmailService</span><span class="p">)</span> <span class="p">{}</span>

  <span class="p">@</span><span class="nd">MessagePattern</span><span class="p">(</span><span class="dl">'</span><span class="s1">new-album</span><span class="dl">'</span><span class="p">)</span>
  <span class="nx">onNewAlbum</span><span class="p">(@</span><span class="nd">Payload</span><span class="p">()</span> <span class="nx">data</span><span class="p">:</span> <span class="nx">NewAlbumMessage</span><span class="p">,</span> <span class="p">@</span><span class="nd">Ctx</span><span class="p">()</span> <span class="nx">context</span><span class="p">:</span> <span class="nx">RmqContext</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">email</span><span class="p">.</span><span class="nx">notifyNewAlbum</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
  <span class="p">}</span>

<span class="p">}</span>
</pre></table></code></div></div><p>Cuando un mensaje de <code class="language-plaintext highlighter-rouge">new-album</code> sea recibido por nuestro controlador, se invocará el servicio de email para enviar una notificación a los usuarios interesados en el artista.</p><h3 id="configuración-del-cliente-de-mensajería"><span class="mr-2">Configuración del cliente de mensajería</span><a href="#configuración-del-cliente-de-mensajería" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Ahora debemos crear un cliente de RabbitMQ que se encargará de enviar mensajes a la cola. Lo haremos mediante el método <code class="language-plaintext highlighter-rouge">registerAsync()</code> del módulo <code class="language-plaintext highlighter-rouge">ClientModule</code> y definiremos la siguiente configuración:</p><div class="language-typescript highlighter-rouge"><div class="code-header"> <span data-label-text="TypeScript"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="¡Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
</pre><td class="rouge-code"><pre>
<span class="k">export</span> <span class="kd">const</span> <span class="nx">RABBITMQ_PRODUCER_CLIENT</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">spotifyclone-queue-client</span><span class="dl">'</span>
<span class="k">export</span> <span class="kd">const</span> <span class="nx">QUEUE_NAME</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">spotify-queue</span><span class="dl">'</span>

<span class="p">@</span><span class="nd">Module</span><span class="p">({</span>
    <span class="na">imports</span><span class="p">:</span> <span class="p">[</span>
        <span class="nx">ClientsModule</span><span class="p">.</span><span class="nx">registerAsync</span><span class="p">([</span>
            <span class="p">{</span>
                <span class="na">name</span><span class="p">:</span> <span class="nx">RABBITMQ_PRODUCER_CLIENT</span><span class="p">,</span>
                <span class="na">imports</span><span class="p">:</span> <span class="p">[</span>
                    <span class="nx">ConfigModule</span><span class="p">.</span><span class="nx">forRoot</span><span class="p">()</span>
                <span class="p">],</span>
                <span class="na">useFactory</span><span class="p">:</span> <span class="p">(</span><span class="na">config</span><span class="p">:</span> <span class="nx">ConfigService</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
                    <span class="kd">const</span> <span class="nx">user</span> <span class="o">=</span> <span class="nx">config</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">RABBITMQ_USER</span><span class="dl">'</span><span class="p">)</span>
                    <span class="kd">const</span> <span class="nx">password</span> <span class="o">=</span> <span class="nx">config</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">RABBITMQ_PASS</span><span class="dl">'</span><span class="p">)</span>
                    <span class="kd">const</span> <span class="nx">host</span> <span class="o">=</span> <span class="nx">config</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">RABBITMQ_HOST</span><span class="dl">'</span><span class="p">)</span>
                    <span class="kd">const</span> <span class="nx">amqp</span> <span class="o">=</span> <span class="s2">`amqp://</span><span class="p">${</span><span class="nx">user</span><span class="p">}</span><span class="s2">:</span><span class="p">${</span><span class="nx">password</span><span class="p">}</span><span class="s2">@</span><span class="p">${</span><span class="nx">host</span><span class="p">}</span><span class="s2">:5672`</span>
                    <span class="k">return</span> <span class="p">{</span>
                        <span class="na">transport</span><span class="p">:</span> <span class="nx">Transport</span><span class="p">.</span><span class="nx">RMQ</span><span class="p">,</span>
                        <span class="na">options</span><span class="p">:</span> <span class="p">{</span>
                            <span class="na">urls</span><span class="p">:</span> <span class="p">[</span>
                                <span class="nx">amqp</span>
                            <span class="p">],</span>
                            <span class="na">queue</span><span class="p">:</span> <span class="nx">QUEUE_NAME</span><span class="p">,</span>
                            <span class="na">queueOptions</span><span class="p">:</span> <span class="p">{</span>
                                <span class="na">durable</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
                            <span class="p">},</span>
                        <span class="p">},</span>
                    <span class="p">}</span>
                <span class="p">},</span>
                <span class="na">inject</span><span class="p">:</span> <span class="p">[</span>
                    <span class="nx">ConfigService</span>
                <span class="p">]</span>
            <span class="p">}</span>
        <span class="p">]),</span>
    <span class="p">],</span>
    <span class="na">exports</span><span class="p">:</span> <span class="p">[</span>
        <span class="nx">RabbitmqClient</span><span class="p">,</span>
    <span class="p">],</span>
    <span class="na">providers</span><span class="p">:</span> <span class="p">[</span>
        <span class="nx">RabbitmqClient</span>
    <span class="p">]</span>
<span class="p">})</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">RabbitmqQueueModule</span> <span class="p">{</span>

    <span class="k">static</span> <span class="nx">getMicroserviceOptions</span><span class="p">(){</span>
        <span class="c1">// ... more code</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Este código creará un cliente de RabbitMQ que podremos utilizar en nuestros microservicios. Sin embargo, iremos un paso más allá y crearemos un servicio más personalizado para evitar estar acoplados a la librería de NestJS.</p><p>Definiremos la estructura general de nuestros mensajes que serán enviados entre nuestros microservicios de <strong>Spotify-Clone</strong>.</p><div class="language-typescript highlighter-rouge"><div class="code-header"> <span data-label-text="TypeScript"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="¡Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre><span class="k">export</span> <span class="kr">interface</span> <span class="nx">RabbitmqMessage</span><span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="na">id</span><span class="p">:</span> <span class="kr">string</span><span class="p">;</span>
    <span class="nl">pattern</span><span class="p">:</span> <span class="kr">string</span><span class="p">;</span>
    <span class="nl">timestamp</span><span class="p">:</span> <span class="nb">Date</span><span class="p">;</span>
    <span class="nl">data</span><span class="p">:</span> <span class="nx">T</span><span class="p">;</span>
<span class="p">}</span>
<span class="c1">// Definimos los mensajes que se enviarán entre microservicios</span>

<span class="k">export</span> <span class="kr">interface</span> <span class="nx">NewAlbumDataMessage</span> <span class="p">{</span>
    <span class="nl">albumId</span><span class="p">:</span> <span class="kr">string</span><span class="p">;</span>
    <span class="nl">title</span><span class="p">:</span> <span class="kr">string</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">export</span> <span class="kd">type</span> <span class="nx">NewAlbumMessage</span> <span class="o">=</span> <span class="nx">RabbitmqMessage</span><span class="o">&lt;</span><span class="nx">NewAlbumDataMessage</span><span class="o">&gt;</span>
</pre></table></code></div></div><p>Y definimos ahora un servicio que será encargado de enviar mensajes.</p><div class="language-typescript highlighter-rouge"><div class="code-header"> <span data-label-text="TypeScript"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="¡Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre><span class="p">@</span><span class="nd">Injectable</span><span class="p">()</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">RabbitmqClient</span> <span class="p">{</span>

    <span class="kd">constructor</span><span class="p">(@</span><span class="nd">Inject</span><span class="p">(</span><span class="nx">RABBITMQ_PRODUCER_CLIENT</span><span class="p">)</span> <span class="k">private</span> <span class="nx">client</span><span class="p">:</span> <span class="nx">ClientProxy</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>

    <span class="nx">emitTo</span><span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;</span><span class="p">(</span><span class="nx">pattern</span><span class="p">:</span> <span class="kr">string</span><span class="p">,</span> <span class="nx">data</span><span class="p">:</span> <span class="nx">T</span><span class="p">):</span> <span class="nx">RabbitmqMessage</span><span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;</span> <span class="p">{</span>
        <span class="kd">const</span> <span class="na">message</span><span class="p">:</span> <span class="nx">RabbitmqMessage</span><span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;</span> <span class="o">=</span> <span class="p">{</span>
            <span class="na">id</span><span class="p">:</span> <span class="nx">uuidv4</span><span class="p">(),</span>
            <span class="na">pattern</span><span class="p">:</span> <span class="nx">pattern</span><span class="p">,</span>
            <span class="na">timestamp</span><span class="p">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(),</span>
            <span class="na">data</span><span class="p">:</span> <span class="nx">data</span>
        <span class="p">}</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">client</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="nx">pattern</span><span class="p">,</span> <span class="nx">message</span><span class="p">)</span>
        <span class="k">return</span> <span class="nx">message</span>
    <span class="p">}</span>

<span class="p">}</span>
</pre></table></code></div></div><p>Y para usar nuestro cliente en alguna aplicación de NestJS, importamos el módulo <code class="language-plaintext highlighter-rouge">RabbitMQModule</code>.</p><div class="language-typescript highlighter-rouge"><div class="code-header"> <span data-label-text="TypeScript"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="¡Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="p">@</span><span class="nd">Module</span><span class="p">({</span>
    <span class="na">imports</span><span class="p">:</span> <span class="p">[</span>
        <span class="nx">RabbitmqQueueModule</span><span class="p">,</span>
        <span class="c1">// other imports</span>
    <span class="p">],</span>
    <span class="c1">// other modules</span>
<span class="p">})</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">MusicLibraryModule</span> <span class="p">{}</span>
</pre></table></code></div></div><p>Y usamos el servicio donde queramos enviar mensajes.</p><div class="language-typescript highlighter-rouge"><div class="code-header"> <span data-label-text="TypeScript"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="¡Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre><td class="rouge-code"><pre><span class="p">@</span><span class="nd">Injectable</span><span class="p">()</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">AlbumService</span> <span class="p">{</span>

  <span class="kd">constructor</span><span class="p">(</span>
    <span class="p">@</span><span class="nd">InjectRepository</span><span class="p">(</span><span class="nx">Album</span><span class="p">)</span> <span class="k">private</span> <span class="nx">albumRepository</span><span class="p">:</span> <span class="nx">Repository</span><span class="o">&lt;</span><span class="nx">Album</span><span class="o">&gt;</span><span class="p">,</span>
    <span class="p">@</span><span class="nd">InjectRepository</span><span class="p">(</span><span class="nx">Artist</span><span class="p">)</span> <span class="k">private</span> <span class="nx">artistRepository</span><span class="p">:</span> <span class="nx">Repository</span><span class="o">&lt;</span><span class="nx">Artist</span><span class="o">&gt;</span><span class="p">,</span>
    <span class="k">private</span> <span class="nx">rabbitmqClient</span><span class="p">:</span> <span class="nx">RabbitmqClient</span><span class="p">,</span>
  <span class="p">)</span> <span class="p">{</span> <span class="p">}</span>

  <span class="k">async</span> <span class="nx">save</span><span class="p">(</span><span class="nx">album</span><span class="p">:</span> <span class="nx">CreateAlbumRequest</span><span class="p">)</span> <span class="p">{</span>

    <span class="kd">const</span> <span class="nx">artist</span> <span class="o">=</span> <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">artistRepository</span><span class="p">.</span><span class="nx">findOneBy</span><span class="p">({</span> <span class="na">id</span><span class="p">:</span> <span class="nx">album</span><span class="p">.</span><span class="nx">artistId</span> <span class="p">})</span>

    <span class="kd">const</span> <span class="nx">albumCreated</span> <span class="o">=</span> <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">albumRepository</span><span class="p">.</span><span class="nx">save</span><span class="p">({</span>
      <span class="na">title</span><span class="p">:</span> <span class="nx">album</span><span class="p">.</span><span class="nx">title</span><span class="p">,</span>
      <span class="na">photo</span><span class="p">:</span> <span class="nx">album</span><span class="p">.</span><span class="nx">photo</span><span class="p">,</span>
      <span class="na">artist</span><span class="p">:</span> <span class="nx">artist</span><span class="p">,</span>
      <span class="na">year</span><span class="p">:</span> <span class="nx">album</span><span class="p">.</span><span class="nx">year</span><span class="p">,</span>
    <span class="p">})</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">rabbitmqClient</span><span class="p">.</span><span class="nx">emitTo</span><span class="o">&lt;</span><span class="nx">NewAlbumDataMessage</span><span class="o">&gt;</span><span class="p">(</span><span class="dl">'</span><span class="s1">new-album</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span> 
      <span class="na">albumId</span><span class="p">:</span> <span class="nx">albumCreated</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span>
      <span class="na">title</span><span class="p">:</span> <span class="nx">albumCreated</span><span class="p">.</span><span class="nx">title</span>
    <span class="p">})</span>
    
    <span class="k">return</span> <span class="nx">albumCreated</span>

  <span class="p">}</span>

<span class="p">}</span>
</pre></table></code></div></div><p>Ahora, el servicio de álbum, al crear un álbum, enviará un mensaje a RabbitMQ. Todos los clientes que se suscriban a la cola recibirán el mensaje y podrán realizar las operaciones pertinentes.</p><p>Este enfoque nos trae los siguientes beneficios:</p><ul><li>Desacoplamos la lógica de un caso de uso (crear álbum) de lógicas de notificaciones (email).<li>El sistema queda extensible a otros casos de uso de forma desacoplada del principal.<li>Hemos agregado escalabilidad a nuestro ecosistema de microservicios.</ul><p>Si bien este es un ejemplo básico, existen múltiples configuraciones en arquitecturas orientadas a comunicaciones asíncronas.</p><p>El ejemplo completo está disponible levantando los siguientes servicios:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="¡Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="c">#!/bin/bash</span>
<span class="c"># up infrastructure with docker-compose</span>
npm run start:infra
<span class="c"># start music-library microservice</span>
npm run start:music-library
<span class="c"># start mailing microservice</span>
npm run start:mailing
</pre></table></code></div></div><h2 id="conclusión"><span class="mr-2">Conclusión</span><a href="#conclusión" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>La comunicación entre microservicios de forma sincrónica nos dará la versatilidad de crear aplicaciones con responsabilidades únicas. Cada uno de estos componentes podrá comunicarse con otros de forma sencilla cuando la comunicación de estos no involucra temas de latencia y de responsabilidad. En este caso nos convendrá utilizar una comunicación asíncrona, la cual nos dará la posibilidad de crear sistemas escalables y de alto rendimiento. Cada enfoque debe ser adecuado al caso, pero básicamente estas 2 formas de comunicación las encontrarás implementadas de múltiples maneras en arquitecturas basadas en microservicios.</p><h2 id="github-repository"><span class="mr-2"><a href="https://github.com/nullpointer-excelsior/microservices-architecture-nestjs/">Github repository</a></span><a href="#github-repository" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p><img data-src="https://i.ibb.co/brkwvxG/Screenshot-2023-12-13-at-19-01-49.png" alt="meme" data-proofer-ignore></p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='//categories/microservicios/'>Microservicios,</a>, <a href='//categories/nestjs-rabbitmq/'>NestJs,RabbitMQ</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="//tags/microservicios-rabbitmq/" class="post-tag no-text-decoration" >microservicios,rabbitmq,</a> <a href="//tags/typescript/" class="post-tag no-text-decoration" >typescript,</a> <a href="//tags/javascript/" class="post-tag no-text-decoration" >javascript</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> Esta entrada está licenciada bajo <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> por el autor.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Compartir</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Microservicios+3+Comunicaci%C3%B3n+entre+microservicios+-+Nullpointer+Excelsior&url=https%3A%2F%2Fnullpointer-excelsior.github.io%2Fposts%2Fcomunicaci%25C3%25B3n-entre-microservicios%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Microservicios+3+Comunicaci%C3%B3n+entre+microservicios+-+Nullpointer+Excelsior&u=https%3A%2F%2Fnullpointer-excelsior.github.io%2Fposts%2Fcomunicaci%25C3%25B3n-entre-microservicios%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Fnullpointer-excelsior.github.io%2Fposts%2Fcomunicaci%25C3%25B3n-entre-microservicios%2F&text=Microservicios+3+Comunicaci%C3%B3n+entre+microservicios+-+Nullpointer+Excelsior" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Fnullpointer-excelsior.github.io%2Fposts%2Fcomunicaci%25C3%25B3n-entre-microservicios%2F" data-toggle="tooltip" data-placement="top" title="Linkedin" target="_blank" rel="noopener" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copiar enlace" data-title-succeed="¡Enlace copiado!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Actualizado recientemente</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/microservicios-observabilidad-en-microservicios-un-ejemplo-practico-de-trazas-distribuidas/">Microservicios 2 Observabilidad en NestJs, un ejemplo práctico de trazas distribuidas</a><li><a href="/posts/realtime-with-reactive-programming/">Aplicaciones en tiempo real con programación reactiva</a><li><a href="/posts/tranajando-con-1millon-de-registros-con-java-stream/">Trabajando con 1 millón de registros con Java Stream</a><li><a href="/posts/disenando-microservicios-con-ddd/">Diseñando Microservicios con Domain Driven Design y NestJS</a><li><a href="/posts/alto-rendimiento-con-cqrs-eventos-en-nestjs/">CQRS en Soluciones de Alto Rendimiento con Nestjs</a></ul></div><div id="access-tags"><div class="panel-heading">Etiquetas populares</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/typescript/">typescript</a> <a class="post-tag" href="/tags/nestjs/">nestjs</a> <a class="post-tag" href="/tags/arquitectura/">arquitectura</a> <a class="post-tag" href="/tags/hexagonal/">hexagonal</a> <a class="post-tag" href="/tags/javascript/">javascript</a> <a class="post-tag" href="/tags/frontend/">frontend</a> <a class="post-tag" href="/tags/java/">Java</a> <a class="post-tag" href="/tags/microservicios/">microservicios,</a> <a class="post-tag" href="/tags/typescript/">Typescript</a> <a class="post-tag" href="/tags/architecture/">Architecture</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contenido</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Lecturas adicionales</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/Ejemplo-programaci%C3%B3n-reactiva-100-Real-No-Fake/"><div class="card-body"> <em class="small" data-ts="1663716720" data-df="YYYY-MM-DD" > 2022-09-20 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Ejemplo programación reactiva 100% Real No Fake</h3><div class="text-muted small"><p> Ejemplo programación reactiva 100% Real No Fake La programación reactiva es un paradigma enfocado en el trabajo con flujos de datos finitos o infinitos de manera asíncrona. Su concepción y evoluci...</p></div></div></a></div><div class="card"> <a href="/posts/Usando-los-Hooks-de-React-m%C3%A1s-all%C3%A1-del-useState/"><div class="card-body"> <em class="small" data-ts="1663803120" data-df="YYYY-MM-DD" > 2022-09-21 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Usando los Hooks de React más allá del useState</h3><div class="text-muted small"><p> Usando los Hooks de React más allá del useState Hack 1 - Petición asíncrona con useState() y useEffect() juntos El siguiente componente muestra los datos obtenidos mediante una operación asíncron...</p></div></div></a></div><div class="card"> <a href="/posts/arquitectura-frontend-1-como-integrar-rxjs-4-react-para-aplicaciones-asincronas-complejas/"><div class="card-body"> <em class="small" data-ts="1692640120" data-df="YYYY-MM-DD" > 2023-08-21 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Arquitectura Frontend 1. Cómo integrar RxJS en React para aplicaciones asíncronas complejas</h3><div class="text-muted small"><p> React es una excelente librería para crear componentes visuales. También nos brinda los hooks, con los cuales podemos trabajar con estados y efectos secundarios en situaciones asíncronas. Si bien...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="//posts/microservicios-observabilidad-en-microservicios-un-ejemplo-practico-de-trazas-distribuidas/" class="btn btn-outline-primary" prompt="Anterior"><p>Microservicios 2 Observabilidad en NestJs, un ejemplo práctico de trazas distribuidas</p></a> <a href="//posts/comunicacion-sincrona-avanzada-en-microservicios/" class="btn btn-outline-primary" prompt="Nuevo"><p>Comunicación síncrona avanzada en Microservicios</p></a></div></div></div><footer class="row pl-3 pr-3"><div class="col-12 d-flex justify-content-between align-items-center text-muted pl-0 pr-0"><div class="footer-left"><p class="mb-0"> © 2025 <a href="https://github.com/nullpointer-excelsior">Benjamin</a>. <span data-toggle="tooltip" data-placement="top" title="Salvo que se indique explícitamente, las entradas de este blog están licenciadas bajo la Creative Commons Attribution 4.0 International (CC BY 4.0) License por el autor.">Algunos derechos reservados.</span></p></div><div class="footer-right"><p class="mb-0"> Hecho con <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> usando el tema <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> .</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Etiquetas populares</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/typescript/">typescript</a> <a class="post-tag" href="/tags/nestjs/">nestjs</a> <a class="post-tag" href="/tags/arquitectura/">arquitectura</a> <a class="post-tag" href="/tags/hexagonal/">hexagonal</a> <a class="post-tag" href="/tags/javascript/">javascript</a> <a class="post-tag" href="/tags/frontend/">frontend</a> <a class="post-tag" href="/tags/java/">Java</a> <a class="post-tag" href="/tags/microservicios/">microservicios,</a> <a class="post-tag" href="/tags/typescript/">Typescript</a> <a class="post-tag" href="/tags/architecture/">Architecture</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">¡Oops! No se encuentran resultados.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/es.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/unregister.js"></script>
