<!DOCTYPE html><html lang="es-ES" data-mode="dark" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="Mono Repositorios con Nestjs Para una Arquitectura Orientada a Eventos" /><meta name="author" content="Benjamin" /><meta property="og:locale" content="es_ES" /><meta name="description" content="Ingeniería de software aplicada, tips, buenas práctias y códigos" /><meta property="og:description" content="Ingeniería de software aplicada, tips, buenas práctias y códigos" /><link rel="canonical" href="https://nullpointer-excelsior.github.io/posts/mono-repo-with-nestjs/" /><meta property="og:url" content="https://nullpointer-excelsior.github.io/posts/mono-repo-with-nestjs/" /><meta property="og:site_name" content="Nullpointer Excelsior" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-12-13T12:32:00-03:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Mono Repositorios con Nestjs Para una Arquitectura Orientada a Eventos" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Benjamin"},"dateModified":"2022-12-15T10:26:24-03:00","datePublished":"2022-12-13T12:32:00-03:00","description":"Ingeniería de software aplicada, tips, buenas práctias y códigos","headline":"Mono Repositorios con Nestjs Para una Arquitectura Orientada a Eventos","mainEntityOfPage":{"@type":"WebPage","@id":"https://nullpointer-excelsior.github.io/posts/mono-repo-with-nestjs/"},"url":"https://nullpointer-excelsior.github.io/posts/mono-repo-with-nestjs/"}</script><title>Mono Repositorios con Nestjs Para una Arquitectura Orientada a Eventos | Nullpointer Excelsior</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Nullpointer Excelsior"><meta name="application-name" content="Nullpointer Excelsior"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" class="mx-auto"> <img src="/assets/img/avatar.webp" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Nullpointer Excelsior</a></div><div class="site-subtitle font-italic">Ingeniería de software aplicada</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>INICIO</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORÍAS</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>ETIQUETAS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVO</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ACERCA DE</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <a href="https://github.com/nullpointer-excelsior" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a></div></div><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4"> <span id="breadcrumb"> <span> <a href="/"> Inicio </a> </span> <span>Mono Repositorios con Nestjs Para una Arquitectura Orientada a Eventos</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Entrada</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Buscar..."> </span> <span id="search-cancel" >Cancelar</span></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container pl-xl-4 pr-xl-4"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4"><div class="post pl-1 pr-1 pl-md-2 pr-md-2"><h1 data-toc-skip>Mono Repositorios con Nestjs Para una Arquitectura Orientada a Eventos</h1><div class="post-meta text-muted"> <span> Publicado <em class="" data-ts="1670945520" data-df="YYYY-MM-DD" data-toggle="tooltip" data-placement="bottom"> 2022-12-13 </em> </span> <span> Actualizado <em class="" data-ts="1671110784" data-df="YYYY-MM-DD" data-toggle="tooltip" data-placement="bottom"> 2022-12-15 </em> </span><div class="d-flex justify-content-between"> <span> Por <em> Benjamin </em> </span><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1992 palabras"> <em>11 min</em> de lectura</span></div></div></div><div class="post-content"><p><img data-src="https://i.ibb.co/Pgt2j53/Screen-Shot-2022-12-13-at-18-24-41.png" alt="image" data-proofer-ignore></p><p>Definir una arquitectura distribuida puede llegar a ser complejo cuando manejas muchos proyectos o servicios y estos tienen que interactuar entre sí. Cada servicio tendrá su propio repositorio y nos dará la ventaja de usar la tecnología adecuada al problema específico a solucionar, pero cuando tu stack tecnológico comparte el mismo lenguaje o framework podrías pensar en usar Monorepositorios. Monorepo es enfoque de desarrollar múltiples aplicaciones dentro de un solo repositorio. Esto podemos verlo muchas veces en arquitecturas de microservicios centralizando todas las aplicaciones dentro de un mismo proyecto donde podremos reutilizar ciertas piezas de software entre aplicaciones sin necesidad de desplegar librerías asociadas a gestores de dependencias. Si bien esto trae ventajas también trae desafíos al momento de desplegar y de definir una arquitectura escalable y mantenible. Pero como todo enfoque este debe ser evaluado según tu caso y necesidades.</p><p>Nestjs nos provee una forma fácil de implementar monorepositorios, su mágica e útil cli nos permite transformar nuestro proyecto con una sola aplicación a múltiples aplicaciones y la posibilidad de definir librerías compartidas.</p><h2 id="creando-un-monorepositorio-con-nestjs"><span class="mr-2">Creando un Monorepositorio con Nestjs</span><a href="#creando-un-monorepositorio-con-nestjs" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Podemos empezar creando una simple aplicación con NestJs</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="¡Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="c">#!/bin/bash</span>
nest new main-application
</pre></table></code></div></div><p>Hemos creado una aplicación llamada <code class="language-plaintext highlighter-rouge">main-application</code> nada nuevo donde el código fuente esta situado en el directorio <code class="language-plaintext highlighter-rouge">src</code>, Pero esta estructura de proyecto puede ser transformada a monorepositorio simplemente agregando una nueva aplicación ingresamos dentro del raíz del proyecto y ejecutamos:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="¡Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="c">#!/bin/bash</span>
nest generate app other-application
</pre></table></code></div></div><p>Nuestra aplicación cambio su estructura, Se creo un nuevo directorio en la raíz del proyecto llamado <code class="language-plaintext highlighter-rouge">apps</code> dentro del cual se ubicaran las aplicaciones. Nuestra carpeta <code class="language-plaintext highlighter-rouge">src</code> es movida a <code class="language-plaintext highlighter-rouge">main-application</code>.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="¡Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre><td class="rouge-code"><pre> apps
├──  main-application
│   ├──  src
│   │   ├──  main.ts
│   │   ├──  producer.controller.spec.ts
│   │   ├──  producer.controller.ts
│   │   ├──  producer.module.ts
│   │   └──  producer.service.ts
│   ├──  <span class="nb">test</span>
│   │   ├──  app.e2e-spec.ts
│   │   └──  jest-e2e.json
│   └──  tsconfig.app.json
└──  other-application
    ├──  src
    │   ├──  app.controller.spec.ts
    │   ├──  app.controller.ts
    │   ├──  app.module.ts
    │   ├──  app.service.ts
    │   └──  main.ts
    ├──  <span class="nb">test</span>
    │   ├──  app.e2e-spec.ts
    │   └──  jest-e2e.json
    └──  tsconfig.app.json
</pre></table></code></div></div><p>Ahora también podemos crear librerías donde podremos compartir código entre aplicaciones.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="¡Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="c">#!/bin/bash</span>
nest generate library shared
</pre></table></code></div></div><p>Esto creará un directorio en la raíz del proyecto llamado <code class="language-plaintext highlighter-rouge">libs</code>.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="¡Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="c">#!/bin/bash</span>
 libs
└──  shared
    ├──  src
    │   ├──  index.ts
    │   ├──  shared.module.ts
    │   ├──  shared.service.spec.ts
    │   └──  shared.service.ts
    └──  tsconfig.lib.json
</pre></table></code></div></div><p>Esto es todo, ya podemos trabajar con monorepositorios dentro de NestJs.</p><h2 id="arquitectura-orientada-a-eventos-utilizando-monorepositorio"><span class="mr-2">Arquitectura orientada a eventos utilizando Monorepositorio</span><a href="#arquitectura-orientada-a-eventos-utilizando-monorepositorio" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Para ver las ventajas que nos dará los monorepositorios implementaremos una arquitectura orientada a eventos utilizando RabbitMQ con una cola de mensajes y una <code class="language-plaintext highlighter-rouge">dead-letter</code> para mensajes fallidos, todo esto mediante la utilización de un custom módulo con NestJs definido como una librería compartida.</p><h3 id="qué-es-rabbitmq"><span class="mr-2">¿Qué es RabbitMQ?</span><a href="#qué-es-rabbitmq" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>RabbitMQ es un broker de mensajería de código abierto, distribuido y escalable, que sirve como intermediario para la comunicación eficiente entre productores y consumidores.</p><p>RabbitMQ implementa el protocolo mensajería de capa de aplicación AMQP (Advanced Message Queueing Protocol), el cual está enfocado en la comunicación de mensajes asíncronos con garantía de entrega, a través de confirmaciones de recepción de mensajes desde el broker al productor y desde los consumidores al broker.</p><h3 id="qué-es-una-dead-letter"><span class="mr-2">¿Qué es una Dead letter?</span><a href="#qué-es-una-dead-letter" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Una Dead Letter es una cola donde los mensajes que no pudieron ser procesados por los consumidores llegan, con esto podemos generar una estrategia de reintento o de registro de que el mensaje no pudo ser procesado.</p><p>En el siguiente repositorio tendremos un stack tecnológico que implementa una arquitectura orientada a eventos con la cual podemos implementar el envío, consumo y reintento de mensajes asíncronos mediante un servidor RabbitMQ. Este proyecto es ideal para generar una estrategia de dead-letter-queue para la recuperación de operaciones fallidas siguiendo la arquitectura modular de nestjs y sus buenas prácticas.</p><h2 id="módulo-rabbitmq-queue"><span class="mr-2">Módulo Rabbitmq-queue</span><a href="#módulo-rabbitmq-queue" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Este módulo fue diseñado con el paquete <code class="language-plaintext highlighter-rouge">@nestjs/microservices</code> de Nestjs y contiene las siguientes características:</p><ul><li><code class="language-plaintext highlighter-rouge">Consumer de Mensajes:</code> Factory de creación de microservicio Worker<li><code class="language-plaintext highlighter-rouge">Dead Letter Consumer de mensajes no procesados por error en el consumer:</code> Factory de creación de microservicio Recovery<li><code class="language-plaintext highlighter-rouge">Cliente Productor de mensajes:</code> Servicio Nesjs Injectable importando <code class="language-plaintext highlighter-rouge">RabbitmqModule</code></ul><p>Nuestro módulo puede ser importado y utilizado por las aplicaciones que definamos en el directorio <code class="language-plaintext highlighter-rouge">apps/</code> y desde cualquier librería o módulo compartido que definamos en <code class="language-plaintext highlighter-rouge">libs/</code></p><p>Este proyecto requiere Node 14 o superior. instala sus dependencias y empezaremos a definir una estructura básica de prodctor, consumidor y control de errores</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="¡Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="c">#!/bin/bash</span>
npm <span class="nb">install</span>
</pre></table></code></div></div><h2 id="levantando-un-servidor-rabbitmq"><span class="mr-2">Levantando un servidor RabbitMQ</span><a href="#levantando-un-servidor-rabbitmq" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Debes tener instalado docker y ejecutar la siguiente instrucción:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="¡Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="c">#!/bin/bash</span>
docker run <span class="nt">--rm</span> <span class="nt">-it</span> <span class="nt">--hostname</span> rabbit-server <span class="nt">-e</span> <span class="nv">RABBITMQ_DEFAULT_VHOST</span><span class="o">=</span>mono-repo-example <span class="nt">-p</span> 15672:15672 <span class="nt">-p</span> 5672:5672 rabbitmq:3-management
</pre></table></code></div></div><h2 id="stack-de-aplicaciones"><span class="mr-2">Stack de Aplicaciones</span><a href="#stack-de-aplicaciones" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Para configurar las aplicaciones que estarán en la misma cola RabbitMQ escuchando los eventos introduciré 3 conceptos:</p><ul><li><code class="language-plaintext highlighter-rouge">Producer:</code> aplicación encargada de enviar mensajes a una cola<li><code class="language-plaintext highlighter-rouge">Worker:</code> aplicación encargada de realizar una tarea especifica dependiendo del mensjae. Será quien consuma los mensajes de una cola<li><code class="language-plaintext highlighter-rouge">Recovery:</code> “Dead Letter Queue” aplicación encargada de consumir mensajes que no pudieron ser procesados por algún error en la aplicación <code class="language-plaintext highlighter-rouge">Worker</code></ul><p>Estas 3 aplicaciones deben compartir una configuración en comúm para que puedan funcionar en conjunto. Y esta es definida por la interface <code class="language-plaintext highlighter-rouge">RabbitmqQueueModuleOptions</code></p><p>Ejemplo de configuración Base:</p><div class="language-typescript highlighter-rouge"><div class="code-header"> <span data-label-text="TypeScript"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="¡Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre><span class="kd">const</span> <span class="nx">options</span><span class="p">:</span> <span class="nx">RabbitmqQueueModuleOptions</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">credentials</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">host</span><span class="p">:</span> <span class="dl">'</span><span class="s1">localhost</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">password</span><span class="p">:</span> <span class="dl">'</span><span class="s1">guest</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">port</span><span class="p">:</span> <span class="mi">5672</span><span class="p">,</span>
      <span class="na">vhost</span><span class="p">:</span> <span class="dl">'</span><span class="s1">mono-repo-example</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">user</span><span class="p">:</span> <span class="dl">'</span><span class="s1">guest</span><span class="dl">'</span>
    <span class="p">},</span>
    <span class="na">queue</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">name</span><span class="p">:</span> <span class="dl">'</span><span class="s1">my-queue</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">deadLetter</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">exchange</span><span class="p">:</span> <span class="dl">'</span><span class="s1">dlx</span><span class="dl">'</span><span class="p">,</span>
        <span class="na">patterns</span><span class="p">:</span> <span class="p">[</span><span class="dl">'</span><span class="s1">SEND_MESSAGE</span><span class="dl">'</span><span class="p">]</span> <span class="c1">// dead-letter for specific message pattern</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>

</pre></table></code></div></div><p>También deben compartir la estructura del mensaje que serán enviados a RabbitMQ. Esta estructura puede ser definida de acuerdo a tus necesidades.</p><p>Ejemplo de una estructura de mensaje</p><div class="language-typescript highlighter-rouge"><div class="code-header"> <span data-label-text="TypeScript"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="¡Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="kr">interface</span> <span class="nx">Data</span> <span class="p">{</span>
    <span class="nl">name</span><span class="p">:</span> <span class="kr">string</span>
    <span class="nx">message</span><span class="p">:</span> <span class="kr">string</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Ya definida nuestra configuración y estructura de mensaje, Podemos empezar a levantar nuestras aplicaciones</p><h3 id="iniciar-worker"><span class="mr-2">Iniciar Worker</span><a href="#iniciar-worker" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Para iniciar una aplicaión <code class="language-plaintext highlighter-rouge">Worker</code> debes ir a tu proyecto Nestjs en este caso sería <code class="language-plaintext highlighter-rouge">apps/worker</code> y en el archivo <code class="language-plaintext highlighter-rouge">apps/worker/main.ts</code> debes invocar la función <code class="language-plaintext highlighter-rouge">createWorkerMicroserviceOptions</code> el cual devolverá un objeto <code class="language-plaintext highlighter-rouge">ClientProviderOptions</code> el cual es necesario para iniciar un microservicio de Nestjs</p><p>Ejemplo main.ts</p><div class="language-typescript highlighter-rouge"><div class="code-header"> <span data-label-text="TypeScript"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="¡Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
</pre><td class="rouge-code"><pre>
<span class="k">async</span> <span class="kd">function</span> <span class="nx">bootstrap</span><span class="p">()</span> <span class="p">{</span>
  
  <span class="kd">const</span> <span class="nx">options</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">credentials</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">host</span><span class="p">:</span> <span class="dl">'</span><span class="s1">localhost</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">password</span><span class="p">:</span> <span class="dl">'</span><span class="s1">guest</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">port</span><span class="p">:</span> <span class="mi">5672</span><span class="p">,</span>
      <span class="na">vhost</span><span class="p">:</span> <span class="dl">'</span><span class="s1">javel</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">user</span><span class="p">:</span> <span class="dl">'</span><span class="s1">guest</span><span class="dl">'</span>
    <span class="p">},</span>
    <span class="na">queue</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">name</span><span class="p">:</span> <span class="dl">'</span><span class="s1">my-queue</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">deadLetter</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">exchange</span><span class="p">:</span> <span class="dl">'</span><span class="s1">dlx</span><span class="dl">'</span><span class="p">,</span>
        <span class="na">patterns</span><span class="p">:</span> <span class="p">[</span><span class="dl">'</span><span class="s1">SEND_MESSAGE</span><span class="dl">'</span><span class="p">]</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="c1">// Build ClientProviderOptions for Worker Microservice</span>
  <span class="kd">const</span> <span class="nx">workerMicroservice</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">RabbitmqQueueModule</span><span class="p">.</span><span class="nx">createWorkerMicroserviceOptions</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span>
  <span class="c1">// Init Microservice</span>
  <span class="kd">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">NestFactory</span><span class="p">.</span><span class="nx">createMicroservice</span><span class="p">(</span><span class="nx">WorkerModule</span><span class="p">,</span> <span class="nx">workerMicroservice</span><span class="p">);</span>
  
  <span class="k">await</span> <span class="nx">app</span><span class="p">.</span><span class="nx">listen</span><span class="p">()</span>

<span class="p">}</span>
<span class="nx">bootstrap</span><span class="p">();</span>

</pre></table></code></div></div><h3 id="definir-worker-controller-para-obtener-mensajes"><span class="mr-2">Definir Worker controller para obtener mensajes.</span><a href="#definir-worker-controller-para-obtener-mensajes" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Ahora para definir los controladores que consumirán los mensajes es de igual forma, manera que nos indica la documentación de Nestjs. El valor de <code class="language-plaintext highlighter-rouge">MessagePattern</code> debe coincidir con las configuraciones base si se necesita usar una Dead letter desde la App <code class="language-plaintext highlighter-rouge">Recovery</code>.</p><div class="language-typescript highlighter-rouge"><div class="code-header"> <span data-label-text="TypeScript"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="¡Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre><span class="p">@</span><span class="nd">Controller</span><span class="p">(</span><span class="dl">'</span><span class="s1">consumer</span><span class="dl">'</span><span class="p">)</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">ConsumerController</span> <span class="p">{</span>

    <span class="p">@</span><span class="nd">EventPattern</span><span class="p">(</span><span class="dl">'</span><span class="s1">SEND_MESSAGE</span><span class="dl">'</span><span class="p">,</span> <span class="nx">Transport</span><span class="p">.</span><span class="nx">RMQ</span><span class="p">)</span>    
    <span class="nx">consume</span><span class="p">(@</span><span class="nd">Payload</span><span class="p">()</span> <span class="nx">data</span><span class="p">:</span> <span class="nx">RabbitmqMessage</span><span class="o">&lt;</span><span class="nx">Data</span><span class="o">&gt;</span><span class="p">,</span> <span class="p">@</span><span class="nd">Ctx</span><span class="p">()</span> <span class="nx">context</span><span class="p">:</span> <span class="nx">RmqContext</span><span class="p">)</span> <span class="p">{</span>
        
        <span class="k">try</span> <span class="p">{</span>
            <span class="c1">// Make some operations with message</span>
            <span class="nx">context</span><span class="p">.</span><span class="nx">getChannelRef</span><span class="p">().</span><span class="nx">ack</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">getMessage</span><span class="p">())</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">Logger</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="s2">`An error occured with mnessage: </span><span class="p">${</span><span class="nx">data</span><span class="p">.</span><span class="nx">id</span><span class="p">}</span><span class="s2">`</span><span class="p">);</span>
              <span class="c1">// reject message and set reque = false</span>
              <span class="c1">// this will dead letter our message</span>
              <span class="nx">context</span><span class="p">.</span><span class="nx">getChannelRef</span><span class="p">().</span><span class="nx">reject</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">getMessage</span><span class="p">(),</span> <span class="kc">false</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

<span class="p">}</span>
</pre></table></code></div></div><p>Nuestro controlador debe recibir el siguiente <code class="language-plaintext highlighter-rouge">@Payload()</code>. donde el Tipo Data es nuestra estructura de mensaje definida.</p><div class="language-typescript highlighter-rouge"><div class="code-header"> <span data-label-text="TypeScript"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="¡Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="p">@</span><span class="nd">Payload</span><span class="p">()</span> <span class="nx">data</span><span class="p">:</span> <span class="nx">RabbitmqMessage</span><span class="o">&lt;</span><span class="nx">Data</span><span class="o">&gt;</span>
</pre></table></code></div></div><p>la interface RabbitmqMessage es la siguiente:</p><div class="language-typescript highlighter-rouge"><div class="code-header"> <span data-label-text="TypeScript"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="¡Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="kr">interface</span> <span class="nx">RabbitmqMessage</span><span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="na">id</span><span class="p">:</span> <span class="kr">string</span><span class="p">;</span>
    <span class="nl">pattern</span><span class="p">:</span> <span class="kr">string</span><span class="p">;</span>
    <span class="nl">timestamp</span><span class="p">:</span> <span class="nb">Date</span><span class="p">;</span>
    <span class="nl">data</span><span class="p">:</span> <span class="nx">T</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Nosotros nos debemos preocupar por solo el tipo de data los otros valores son definidos por la librería RabbitmqQueue.</p><h3 id="iniciar-recovery"><span class="mr-2">Iniciar Recovery</span><a href="#iniciar-recovery" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Lo mismo para iniciar la aplicaión <code class="language-plaintext highlighter-rouge">Recovery</code> debes ir a tu proyecto Nestjs en este caso sería apps/recovery y en el archivo <code class="language-plaintext highlighter-rouge">apps/recovery/main.ts</code> debes invocar la función <code class="language-plaintext highlighter-rouge">createRecoveryMicroserviceOptions</code> el cual devolverá un objeto <code class="language-plaintext highlighter-rouge">ClientProviderOptions</code> el cual es necesario para iniciar un microservicio de Nestjs</p><div class="language-typescript highlighter-rouge"><div class="code-header"> <span data-label-text="TypeScript"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="¡Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre><td class="rouge-code"><pre><span class="k">async</span> <span class="kd">function</span> <span class="nx">bootstrap</span><span class="p">()</span> <span class="p">{</span>

  <span class="kd">const</span> <span class="nx">options</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">credentials</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">host</span><span class="p">:</span> <span class="dl">'</span><span class="s1">localhost</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">password</span><span class="p">:</span> <span class="dl">'</span><span class="s1">guest</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">port</span><span class="p">:</span> <span class="mi">5672</span><span class="p">,</span>
      <span class="na">vhost</span><span class="p">:</span> <span class="dl">'</span><span class="s1">javel</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">user</span><span class="p">:</span> <span class="dl">'</span><span class="s1">guest</span><span class="dl">'</span>
    <span class="p">},</span>
    <span class="na">queue</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">name</span><span class="p">:</span> <span class="dl">'</span><span class="s1">my-queue</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">deadLetter</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">exchange</span><span class="p">:</span> <span class="dl">'</span><span class="s1">dlx</span><span class="dl">'</span><span class="p">,</span>
        <span class="na">patterns</span><span class="p">:</span> <span class="p">[</span><span class="dl">'</span><span class="s1">SEND_MESSAGE</span><span class="dl">'</span><span class="p">]</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="kd">const</span> <span class="nx">microservice</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">RabbitmqQueueModule</span><span class="p">.</span><span class="nx">createRecoveryMicroserviceOptions</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span>
  <span class="kd">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">NestFactory</span><span class="p">.</span><span class="nx">createMicroservice</span><span class="p">(</span><span class="nx">RecoveryModule</span><span class="p">,</span> <span class="nx">microservice</span><span class="p">);</span>
  <span class="nx">app</span><span class="p">.</span><span class="nx">listen</span><span class="p">()</span>
  
<span class="p">}</span>
<span class="nx">bootstrap</span><span class="p">();</span>
</pre></table></code></div></div><h3 id="definir-recovery-controller-para-obtener-mensajes-que-no-pudieron-ser-procesados-por-worker"><span class="mr-2">Definir Recovery controller para obtener mensajes que no pudieron ser procesados por <code class="language-plaintext highlighter-rouge">Worker</code>.</span><a href="#definir-recovery-controller-para-obtener-mensajes-que-no-pudieron-ser-procesados-por-worker" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Ahora para definir los controladores que consumirán los mensajes fallidos es de igual manera que nos indica la documentación de Nestjs. El valor de MessagePattern debe estar incluido en los valores de <code class="language-plaintext highlighter-rouge">queue.deadLetter.patterns</code></p><div class="language-typescript highlighter-rouge"><div class="code-header"> <span data-label-text="TypeScript"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="¡Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre><span class="p">@</span><span class="nd">Controller</span><span class="p">(</span><span class="dl">'</span><span class="s1">dead-letter-queue</span><span class="dl">'</span><span class="p">)</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">DeadLetterController</span> <span class="p">{</span>

    <span class="p">@</span><span class="nd">EventPattern</span><span class="p">(</span><span class="dl">'</span><span class="s1">SEND_MESSAGE</span><span class="dl">'</span><span class="p">,</span> <span class="nx">Transport</span><span class="p">.</span><span class="nx">RMQ</span><span class="p">)</span>
    <span class="k">async</span> <span class="nx">consume1</span><span class="p">(@</span><span class="nd">Payload</span><span class="p">()</span> <span class="nx">data</span><span class="p">:</span> <span class="nx">RabbitmqMessage</span><span class="o">&lt;</span><span class="nx">Data</span><span class="o">&gt;</span><span class="p">,</span> <span class="p">@</span><span class="nd">Ctx</span><span class="p">()</span> <span class="nx">context</span><span class="p">:</span> <span class="nx">RmqContext</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">Logger</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">Dead-letter SEND_MESSAGE 1: </span><span class="dl">'</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="p">@</span><span class="nd">EventPattern</span><span class="p">(</span><span class="dl">'</span><span class="s1">SEND_MESSAGE2</span><span class="dl">'</span><span class="p">,</span> <span class="nx">Transport</span><span class="p">.</span><span class="nx">RMQ</span><span class="p">)</span>
    <span class="k">async</span> <span class="nx">consume2</span><span class="p">(@</span><span class="nd">Payload</span><span class="p">()</span> <span class="nx">data</span><span class="p">:</span> <span class="nx">RabbitmqMessage</span><span class="o">&lt;</span><span class="nx">Data</span><span class="o">&gt;</span><span class="p">,</span> <span class="p">@</span><span class="nd">Ctx</span><span class="p">()</span> <span class="nx">context</span><span class="p">:</span> <span class="nx">RmqContext</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">Logger</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">Dead-letter SEND_MESSAGE 2: </span><span class="dl">'</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span>
    <span class="p">}</span>

<span class="p">}</span>
</pre></table></code></div></div><h3 id="iniciar-producer"><span class="mr-2">Iniciar Producer</span><a href="#iniciar-producer" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Para iniciar nuestra aplicación solo debemos hacer un registro del RabbitmqQueueModule proporcionando nuestra configuración base en el módulo Nestjs que necesitemos producir mensajes</p><div class="language-typescript highlighter-rouge"><div class="code-header"> <span data-label-text="TypeScript"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="¡Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre><td class="rouge-code"><pre><span class="p">@</span><span class="nd">Module</span><span class="p">({</span>
  <span class="na">imports</span><span class="p">:</span> <span class="p">[</span>
    <span class="nx">RabbitmqQueueModule</span><span class="p">.</span><span class="nx">register</span><span class="p">({</span>
      <span class="na">credentials</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">host</span><span class="p">:</span> <span class="dl">'</span><span class="s1">localhost</span><span class="dl">'</span><span class="p">,</span>
        <span class="na">password</span><span class="p">:</span> <span class="dl">'</span><span class="s1">guest</span><span class="dl">'</span><span class="p">,</span>
        <span class="na">port</span><span class="p">:</span> <span class="mi">5672</span><span class="p">,</span>
        <span class="na">vhost</span><span class="p">:</span> <span class="dl">'</span><span class="s1">javel</span><span class="dl">'</span><span class="p">,</span>
        <span class="na">user</span><span class="p">:</span> <span class="dl">'</span><span class="s1">guest</span><span class="dl">'</span>
      <span class="p">},</span>
      <span class="na">queue</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">name</span><span class="p">:</span> <span class="dl">'</span><span class="s1">my-queue</span><span class="dl">'</span><span class="p">,</span>
        <span class="na">deadLetter</span><span class="p">:</span> <span class="p">{</span>
          <span class="na">exchange</span><span class="p">:</span> <span class="dl">'</span><span class="s1">dlx</span><span class="dl">'</span><span class="p">,</span>
          <span class="na">patterns</span><span class="p">:</span> <span class="p">[</span><span class="dl">'</span><span class="s1">SEND_MESSAGE</span><span class="dl">'</span><span class="p">]</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">})</span>
  <span class="p">],</span>
  <span class="na">controllers</span><span class="p">:</span> <span class="p">[</span><span class="nx">ProducerController</span><span class="p">],</span>
<span class="p">})</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">ProducerModule</span> <span class="p">{</span> <span class="p">}</span>

</pre></table></code></div></div><p>Ahora solo debemos injectar nuestro servicio productor de mensajes:</p><div class="language-typescript highlighter-rouge"><div class="code-header"> <span data-label-text="TypeScript"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="¡Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="k">import</span> <span class="p">{</span> <span class="nx">RabbitmqProducerClient</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">@app/shared/rabbitmq-queue/services/rabbitmq-producer-client.service</span><span class="dl">'</span><span class="p">;</span>

<span class="p">@</span><span class="nd">Injectable</span><span class="p">()</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">MyService</span> <span class="p">{</span>
  
  <span class="kd">constructor</span><span class="p">(</span><span class="k">private</span> <span class="nx">rabbitmq</span><span class="p">:</span> <span class="nx">RabbitmqProducerClient</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>

<span class="p">}</span>

</pre></table></code></div></div><p>Ahora para enviar mensajes lo hacemos de la siguiente manera</p><div class="language-typescript highlighter-rouge"><div class="code-header"> <span data-label-text="TypeScript"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="¡Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre> <span class="kd">const</span> <span class="nx">data</span><span class="p">:</span> <span class="nx">Data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">name</span><span class="p">:</span> <span class="dl">'</span><span class="s1">rabbitmq-message</span><span class="dl">'</span><span class="p">,</span>
    <span class="na">message</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Simple message for testing</span><span class="dl">'</span>
  <span class="p">}</span>
  <span class="kd">const</span> <span class="nx">payload</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">rabbitmq</span><span class="p">.</span><span class="nx">emitTo</span><span class="o">&lt;</span><span class="nx">Data</span><span class="o">&gt;</span><span class="p">(</span><span class="dl">'</span><span class="s1">SEND_MESSAGE</span><span class="dl">'</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span>

</pre></table></code></div></div><p>el metódo <code class="language-plaintext highlighter-rouge">emitTo()</code> nos devolverá el mensaje que enviará a Rabbitmq</p><div class="language-json highlighter-rouge"><div class="code-header"> <span data-label-text="JSON"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="¡Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="p">{</span><span class="w">
  </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"bb322090-578d-4717-9d12-a38eadbd0311"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"pattern"</span><span class="p">:</span><span class="w"> </span><span class="s2">"SEND_MESSAGE"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"timestamp"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2022-11-09T13:18:45.704Z"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"rabbitmq-message"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"message"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Simple message for testing"</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></table></code></div></div><p>Generamos un controlador de pruebas para probar nuestra arquitectura orientada a eventos</p><div class="language-typescript highlighter-rouge"><div class="code-header"> <span data-label-text="TypeScript"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="¡Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre><span class="p">@</span><span class="nd">Controller</span><span class="p">(</span><span class="dl">'</span><span class="s1">producer</span><span class="dl">'</span><span class="p">)</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">ProducerController</span> <span class="p">{</span>

  <span class="kd">constructor</span><span class="p">(</span><span class="k">private</span> <span class="nx">rabbitmq</span><span class="p">:</span> <span class="nx">RabbitmqProducerClient</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>

  <span class="p">@</span><span class="nd">Post</span><span class="p">()</span>
  <span class="nx">emitMessage</span><span class="p">(@</span><span class="nd">Body</span><span class="p">()</span> <span class="nx">data</span><span class="p">:</span> <span class="kr">any</span><span class="p">)</span> <span class="p">{</span>

    <span class="kd">const</span> <span class="nx">payload</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">rabbitmq</span><span class="p">.</span><span class="nx">emitTo</span><span class="o">&lt;</span><span class="nx">Data</span><span class="o">&gt;</span><span class="p">(</span><span class="dl">'</span><span class="s1">SEND_MESSAGE2</span><span class="dl">'</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span>
    <span class="nx">Logger</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`Producer: message sent </span><span class="p">${</span><span class="nx">payload</span><span class="p">.</span><span class="nx">id</span><span class="p">}</span><span class="s2">`</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span>
      <span class="na">message</span><span class="p">:</span> <span class="dl">'</span><span class="s1">OK</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">messageSent</span><span class="p">:</span> <span class="nx">payload</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

</pre></table></code></div></div><p>Y generamos la siguiente instrucción en curl para realizar la petición:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="¡Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="c">#!/bin/bash</span>
curl <span class="nt">-s</span> <span class="nt">-X</span> POST <span class="nt">-d</span> <span class="s1">'{"name": "rabbitmq-message","message": "testing message on event architecture"}'</span> <span class="nt">-H</span> <span class="s1">'Content-type: application/json'</span> http://localhost:3001/producer | jq
</pre></table></code></div></div><p>Adicional a este comando puedes hacer uso de Make para realizar las siguientes operaciones:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="¡Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre><span class="c">#!/bin/bash</span>
<span class="c"># start a fucking rabbitmq server</span>
make rabbit
<span class="c"># start worker</span>
make worker
<span class="c"># start recovery</span>
make recovery
<span class="c"># start producer</span>
make producer
<span class="c"># send a request</span>
make produce
<span class="c"># testing dead-letter</span>
make produce<span class="p">;</span> <span class="nb">sleep </span>1<span class="p">;</span> make produce<span class="p">;</span> <span class="nb">sleep </span>1<span class="p">;</span> make produce
</pre></table></code></div></div><h2 id="fin-del-post"><span class="mr-2">Fin del Post</span><a href="#fin-del-post" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Esta es la forma más simple de utilizar una arquitectura orientada a eventos. Generamos un proyecto de tipo mono Repositorio para poder reutilizar nuestras piezas de software y seguir una misma implementación con Nestjs, La estrategia de mono repositorio debes analizarla bien, ya que dependerá de tus necesidades y tipo de proyecto pero para empezar a jugar no está mal.</p><h2 id="github-repository"><span class="mr-2"><a href="https://github.com/nullpointer-excelsior/nestjs-rabbitmq-architecture">Github repository</a></span><a href="#github-repository" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Acá el meme de despedida</p><p><img data-src="https://i.ibb.co/899qQr1/Zombo-Meme-01122022233002.jpg" alt="meme" data-proofer-ignore></p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='//categories/programacion/'>Programacion</a>, <a href='//categories/nestjs/'>Nestjs</a>, <a href='//categories/typescript/'>Typescript</a>, <a href='//categories/events/'>Events</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="//tags/typescript/" class="post-tag no-text-decoration" >typescript</a> <a href="//tags/nestjs/" class="post-tag no-text-decoration" >nestjs</a> <a href="//tags/rabbitmq/" class="post-tag no-text-decoration" >rabbitmq</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> Esta entrada está licenciada bajo <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> por el autor.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Compartir</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Mono+Repositorios+con+Nestjs+Para+una+Arquitectura+Orientada+a+Eventos+-+Nullpointer+Excelsior&url=https%3A%2F%2Fnullpointer-excelsior.github.io%2Fposts%2Fmono-repo-with-nestjs%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Mono+Repositorios+con+Nestjs+Para+una+Arquitectura+Orientada+a+Eventos+-+Nullpointer+Excelsior&u=https%3A%2F%2Fnullpointer-excelsior.github.io%2Fposts%2Fmono-repo-with-nestjs%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Fnullpointer-excelsior.github.io%2Fposts%2Fmono-repo-with-nestjs%2F&text=Mono+Repositorios+con+Nestjs+Para+una+Arquitectura+Orientada+a+Eventos+-+Nullpointer+Excelsior" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Fnullpointer-excelsior.github.io%2Fposts%2Fmono-repo-with-nestjs%2F" data-toggle="tooltip" data-placement="top" title="Linkedin" target="_blank" rel="noopener" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copiar enlace" data-title-succeed="¡Enlace copiado!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Actualizado recientemente</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/microservicios-observabilidad-en-microservicios-un-ejemplo-practico-de-trazas-distribuidas/">Microservicios 2 Observabilidad en NestJs, un ejemplo práctico de trazas distribuidas</a><li><a href="/posts/realtime-with-reactive-programming/">Aplicaciones en tiempo real con programación reactiva</a><li><a href="/posts/tranajando-con-1millon-de-registros-con-java-stream/">Trabajando con 1 millón de registros con Java Stream</a><li><a href="/posts/disenando-microservicios-con-ddd/">Diseñando Microservicios con Domain Driven Design y NestJS</a><li><a href="/posts/alto-rendimiento-con-cqrs-eventos-en-nestjs/">CQRS en Soluciones de Alto Rendimiento con Nestjs</a></ul></div><div id="access-tags"><div class="panel-heading">Etiquetas populares</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/typescript/">typescript</a> <a class="post-tag" href="/tags/nestjs/">nestjs</a> <a class="post-tag" href="/tags/arquitectura/">arquitectura</a> <a class="post-tag" href="/tags/hexagonal/">hexagonal</a> <a class="post-tag" href="/tags/javascript/">javascript</a> <a class="post-tag" href="/tags/frontend/">frontend</a> <a class="post-tag" href="/tags/java/">Java</a> <a class="post-tag" href="/tags/microservicios/">microservicios,</a> <a class="post-tag" href="/tags/typescript/">Typescript</a> <a class="post-tag" href="/tags/architecture/">Architecture</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contenido</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Lecturas adicionales</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/implementando-hexagonal-con-nestjs-part1/"><div class="card-body"> <em class="small" data-ts="1666711920" data-df="YYYY-MM-DD" > 2022-10-25 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Arquitectura hexagonal con nestjs Parte I</h3><div class="text-muted small"><p> No voy a profundizar en que es una arquitectura hexagonal, ya que tenemos un montón de recursos que te lo explican de forma detallada, pero ojo que cuando hablamos de este tipo de arquitecturas d...</p></div></div></a></div><div class="card"> <a href="/posts/implementando-hexagonal-con-nestjs-part2/"><div class="card-body"> <em class="small" data-ts="1666798320" data-df="YYYY-MM-DD" > 2022-10-26 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Arquitectura hexagonal Parte II Conectando una clean architecture con Nestjs</h3><div class="text-muted small"><p> La segunda parte de esta serie de arquitectura hexagonal o (clean architecture) profundizaremos como configurar la interacción de un framework con el core de nuestra arquitectura, Nestjs nos ofre...</p></div></div></a></div><div class="card"> <a href="/posts/nestjs-tips-la-versatilidad-de-configuration-module/"><div class="card-body"> <em class="small" data-ts="1666971120" data-df="YYYY-MM-DD" > 2022-10-28 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Nestjs tips La versatilidad de ConfigMdule</h3><div class="text-muted small"><p> El manejo de credenciales y configuraciones en nuestras aplicaciones es generalmente algo indispensable para los distintos escenarios de desarrollo y despliegue. Algo tedioso a veces, pero nuestr...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="//posts/alto-rendimiento-con-cqrs-eventos-en-nestjs/" class="btn btn-outline-primary" prompt="Anterior"><p>CQRS en Soluciones de Alto Rendimiento con Nestjs</p></a> <a href="//posts/disenando-microservicios-con-ddd/" class="btn btn-outline-primary" prompt="Nuevo"><p>Diseñando Microservicios con Domain Driven Design y NestJS</p></a></div></div></div><footer class="row pl-3 pr-3"><div class="col-12 d-flex justify-content-between align-items-center text-muted pl-0 pr-0"><div class="footer-left"><p class="mb-0"> © 2025 <a href="https://github.com/nullpointer-excelsior">Benjamin</a>. <span data-toggle="tooltip" data-placement="top" title="Salvo que se indique explícitamente, las entradas de este blog están licenciadas bajo la Creative Commons Attribution 4.0 International (CC BY 4.0) License por el autor.">Algunos derechos reservados.</span></p></div><div class="footer-right"><p class="mb-0"> Hecho con <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> usando el tema <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> .</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Etiquetas populares</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/typescript/">typescript</a> <a class="post-tag" href="/tags/nestjs/">nestjs</a> <a class="post-tag" href="/tags/arquitectura/">arquitectura</a> <a class="post-tag" href="/tags/hexagonal/">hexagonal</a> <a class="post-tag" href="/tags/javascript/">javascript</a> <a class="post-tag" href="/tags/frontend/">frontend</a> <a class="post-tag" href="/tags/java/">Java</a> <a class="post-tag" href="/tags/microservicios/">microservicios,</a> <a class="post-tag" href="/tags/typescript/">Typescript</a> <a class="post-tag" href="/tags/architecture/">Architecture</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">¡Oops! No se encuentran resultados.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/es.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/unregister.js"></script>
