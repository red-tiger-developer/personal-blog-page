<!DOCTYPE html><html lang="es-ES" data-mode="dark" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="Microservicios 2 Observabilidad en NestJs, un ejemplo práctico de trazas distribuidas" /><meta name="author" content="Benjamin" /><meta property="og:locale" content="es_ES" /><meta name="description" content="Ingeniería de software aplicada, tips, buenas práctias y códigos" /><meta property="og:description" content="Ingeniería de software aplicada, tips, buenas práctias y códigos" /><link rel="canonical" href="https://nullpointer-excelsior.github.io/posts/microservicios-observabilidad-en-microservicios-un-ejemplo-practico-de-trazas-distribuidas/" /><meta property="og:url" content="https://nullpointer-excelsior.github.io/posts/microservicios-observabilidad-en-microservicios-un-ejemplo-practico-de-trazas-distribuidas/" /><meta property="og:site_name" content="Nullpointer Excelsior" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2023-11-28T02:00:00-03:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Microservicios 2 Observabilidad en NestJs, un ejemplo práctico de trazas distribuidas" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Benjamin"},"dateModified":"2023-11-28T11:54:11-03:00","datePublished":"2023-11-28T02:00:00-03:00","description":"Ingeniería de software aplicada, tips, buenas práctias y códigos","headline":"Microservicios 2 Observabilidad en NestJs, un ejemplo práctico de trazas distribuidas","mainEntityOfPage":{"@type":"WebPage","@id":"https://nullpointer-excelsior.github.io/posts/microservicios-observabilidad-en-microservicios-un-ejemplo-practico-de-trazas-distribuidas/"},"url":"https://nullpointer-excelsior.github.io/posts/microservicios-observabilidad-en-microservicios-un-ejemplo-practico-de-trazas-distribuidas/"}</script><title>Microservicios 2 Observabilidad en NestJs, un ejemplo práctico de trazas distribuidas | Nullpointer Excelsior</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Nullpointer Excelsior"><meta name="application-name" content="Nullpointer Excelsior"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" class="mx-auto"> <img src="/assets/img/avatar.webp" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Nullpointer Excelsior</a></div><div class="site-subtitle font-italic">Ingeniería de software aplicada</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>INICIO</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORÍAS</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>ETIQUETAS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVO</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ACERCA DE</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <a href="https://github.com/nullpointer-excelsior" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a></div></div><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4"> <span id="breadcrumb"> <span> <a href="/"> Inicio </a> </span> <span>Microservicios 2 Observabilidad en NestJs, un ejemplo práctico de trazas distribuidas</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Entrada</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Buscar..."> </span> <span id="search-cancel" >Cancelar</span></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container pl-xl-4 pr-xl-4"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4"><div class="post pl-1 pr-1 pl-md-2 pr-md-2"><h1 data-toc-skip>Microservicios 2 Observabilidad en NestJs, un ejemplo práctico de trazas distribuidas</h1><div class="post-meta text-muted"> <span> Publicado <em class="" data-ts="1701147600" data-df="YYYY-MM-DD" data-toggle="tooltip" data-placement="bottom"> 2023-11-28 </em> </span> <span> Actualizado <em class="" data-ts="1701183251" data-df="YYYY-MM-DD" data-toggle="tooltip" data-placement="bottom"> 2023-11-28 </em> </span><div class="d-flex justify-content-between"> <span> Por <em> Benjamin </em> </span><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="3008 palabras"> <em>16 min</em> de lectura</span></div></div></div><div class="post-content"><p><img data-src="https://i.ibb.co/9Y2M7S8/Screenshot-2023-11-28-at-11-25-27.png" alt="intro" data-proofer-ignore></p><h2 id="introducción"><span class="mr-2">Introducción</span><a href="#introducción" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>En el mundo de los microservicios, la observabilidad es un aspecto crucial para entender el comportamiento y el rendimiento de nuestras aplicaciones. La observabilidad nos permite recopilar y analizar datos de diferentes fuentes para obtener una visión completa de nuestras aplicaciones. Este enfoque holístico no solo nos proporciona una visión exhaustiva de cada componente de nuestras aplicaciones, sino que también nos permite identificar patrones, anomalías y optimizaciones potenciales, contribuyendo así a fortalecer la robustez y eficiencia de nuestras soluciones tecnológicas.</p><p>En este artículo abordaremos cómo implementar trazas distribuidas sobre el flujo de 2 aplicaciones en un entorno de microservicios utilizando OpenTelemetry y JagerUI sobre un sistema de microservicios que emula la plataforma de Spotify. Todo con NestJs 😉.</p><h2 id="las-bases-de-la-observabilidad"><span class="mr-2">Las bases de la observabilidad</span><a href="#las-bases-de-la-observabilidad" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Cuando nos adentramos en el mundo de la observabilidad, escucharemos muy a menudo el concepto de MELT, el cual es un acrónimo que se refiere a los cuatro pilares de la observabilidad: Métricas, Eventos, Logs y Trazas.</p><ul><li><strong>Métricas</strong>: son datos numéricos que representan el estado de nuestra aplicación en un momento dado.<li><strong>Eventos</strong>: son registros de acciones o cambios significativos en nuestra aplicación.<li><strong>Logs</strong>: son registros detallados de las actividades de nuestra aplicación.<li><strong>Trazas</strong>: son representaciones visuales de cómo las solicitudes fluyen a través de nuestra aplicación.</ul><p>Visualmente nos puede quedar más claro con la siguiente imagen:</p><p><img data-src="https://i.ibb.co/FXYNHVf/melt.png" alt="meltex" data-proofer-ignore></p><h2 id="la-importancia-de-las-trazas-en-sistemas-distribuidos"><span class="mr-2">La importancia de las trazas en sistemas distribuidos</span><a href="#la-importancia-de-las-trazas-en-sistemas-distribuidos" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Las trazas en una aplicación distribuida son fundamentales porque ofrecen una ventana detallada hacia el flujo de datos y acciones entre sus distintos componentes. Estas trazas permiten seguir el camino de una solicitud o proceso a través de los diversos servicios, facilitando la detección de problemas, la depuración de errores, la optimización del rendimiento y la comprensión holística de la interacción entre los elementos distribuidos.</p><h2 id="qué-es-opentelemetry"><span class="mr-2">¿Qué es OpenTelemetry?</span><a href="#qué-es-opentelemetry" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p><a href="https://opentelemetry.io/docs/">OpenTelemetry</a> es un conjunto de APIs, bibliotecas y agentes que permiten la recopilación y gestión de telemetría (métricas, logs, trazas) de nuestras aplicaciones. OpenTelemetry es un proyecto de la Cloud Native Computing Foundation (CNCF) y es compatible con una amplia gama de marcos y lenguajes de programación.</p><p>Para el envío de trazas, logs o métricas, las aplicaciones deben instrumentarse. Este trabajo es realizado por las librerías de OpenTelemetry.</p><p>OpenTelemetry no solo soporta la instrumentación de aplicaciones, sino que también podremos instrumentar infraestructura para entender un poco más en detalle cómo funciona la instrumentación. Veamos la siguiente imagen:</p><p><img data-src="https://opentelemetry.io/img/otel-diagram.svg" alt="otel" data-proofer-ignore></p><p>OTel Collector es la pieza de software que recopila datos de telemetría de las aplicaciones y servicios instrumentados. Los datos de telemetría se recopilan en un formato estándar llamado OpenTelemetry Protocol (OTLP). El collector luego puede procesar los datos de telemetría y exportarlos a una variedad de destinos, como bases de datos, sistemas de análisis y paneles de control.</p><h2 id="qué-es-jeager-ui"><span class="mr-2">¿Qué es Jeager UI?</span><a href="#qué-es-jeager-ui" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p><img data-src="https://i.ibb.co/1mFnsJ1/JaegerUI.png" alt="jeager" data-proofer-ignore></p><p>Jaeger es una herramienta de trazado distribuido que permite visualizar y analizar las trazas de nuestras aplicaciones. Con Jaeger, podemos ver cómo las solicitudes fluyen a través de nuestros microservicios y dónde se producen los cuellos de botella o los errores. Algunas de sus características incluyen:</p><ul><li>Propagación de contexto distribuida<li>Monitoreo de transacciones distribuidas<li>Análisis de raíz de la causa<li>Análisis de dependencia del servicio<li>Optimización de rendimiento/latencia</ul><p>Utilizaremos el componente Jeager UI, el cual nos permitirá visualizar las trazas enviadas por aplicaciones que instrumentemos con OpenTelemetry.</p><h2 id="instrumentando-aplicaciones-con-opentelemetry"><span class="mr-2">Instrumentando aplicaciones con OpenTelemetry</span><a href="#instrumentando-aplicaciones-con-opentelemetry" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Para instrumentar nuestros microservicios con OpenTelemetry, necesitamos inicializar el SDK de OpenTelemetry y configurarlo para recopilar métricas, logs y trazas. A continuación, se muestra un ejemplo de cómo podemos hacer esto en TypeScript.</p><p>Instalación. OpenTelemetry tiene un montón de dependencias que deberemos incluir dependiendo de nuestro caso, pero básicamente instalamos los componentes base de telemetría y sdk-node e instrumentaciones específicas de tecnologías que queremos hacer tracing.</p><div class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="¡Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre>npm <span class="nb">install</span> @opentelemetry/context-async-hooks <span class="se">\</span>
    @opentelemetry/exporter-metrics-otlp-proto <span class="se">\</span>
    @opentelemetry/exporter-trace-otlp-http <span class="se">\</span>
    @opentelemetry/instrumentation-amqplib <span class="se">\</span>
    @opentelemetry/instrumentation-express <span class="se">\</span>
    @opentelemetry/instrumentation-http <span class="se">\</span>
    @opentelemetry/instrumentation-pg <span class="se">\</span>
    @opentelemetry/resources <span class="se">\</span>
    @opentelemetry/sdk-metrics <span class="se">\</span>
    @opentelemetry/sdk-node <span class="se">\</span>
    @opentelemetry/sdk-trace-node <span class="se">\</span>
    @opentelemetry/semantic-conventions
</pre></table></code></div></div><p>La siguiente función implementa la instrumentación básica de una aplicación Node.js. Esta función recolectará toda la información de métricas y trazas y las enviará a un servidor OTLP con el cual podremos visualizar los datos de forma gráfica.</p><div class="language-typescript highlighter-rouge"><div class="code-header"> <span data-label-text="TypeScript"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="¡Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
</pre><td class="rouge-code"><pre><span class="k">import</span> <span class="p">{</span> <span class="nx">Logger</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">@nestjs/common</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">metrics</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">@opentelemetry/api</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">AsyncLocalStorageContextManager</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">@opentelemetry/context-async-hooks</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">OTLPMetricExporter</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">@opentelemetry/exporter-metrics-otlp-proto</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">OTLPTraceExporter</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">@opentelemetry/exporter-trace-otlp-http</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">InstrumentationOption</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">@opentelemetry/instrumentation</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">Resource</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">@opentelemetry/resources</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">MeterProvider</span><span class="p">,</span> <span class="nx">PeriodicExportingMetricReader</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">@opentelemetry/sdk-metrics</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">NodeSDK</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">@opentelemetry/sdk-node</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">SemanticResourceAttributes</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">@opentelemetry/semantic-conventions</span><span class="dl">"</span><span class="p">;</span>

<span class="c1">// Tipo de opciones para crear el SDK</span>
<span class="kd">type</span> <span class="nx">CreateSdkOptions</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">serviceName</span><span class="p">:</span> <span class="kr">string</span> <span class="c1">// nombre del servicio el cual poderemos identificar</span>
  <span class="na">serviceVersion</span><span class="p">:</span> <span class="kr">string</span><span class="p">,</span>
  <span class="nx">traceExporterOptions</span><span class="p">?:</span> <span class="p">{</span> <span class="na">url</span><span class="p">:</span> <span class="kr">string</span><span class="p">,</span> <span class="nx">headers</span><span class="p">?:</span> <span class="kr">any</span> <span class="p">},</span>
  <span class="nx">metricExporterOptions</span><span class="p">?:</span> <span class="p">{</span> <span class="na">url</span><span class="p">:</span> <span class="kr">string</span><span class="p">,</span> <span class="nx">headers</span><span class="p">?:</span> <span class="kr">any</span> <span class="p">},</span>
  <span class="nx">instrumentations</span><span class="p">?:</span> <span class="nx">InstrumentationOption</span><span class="p">[]</span> <span class="c1">// implementaciones por defecto que realizan la isntrumentacion de ciertas librerias sin necesidad de hacerlo por nosotros.</span>
<span class="p">}</span>

<span class="c1">// Función para crear el SDK de OpenTelemetry</span>
<span class="k">export</span> <span class="kd">function</span> <span class="nx">createSdk</span><span class="p">(</span><span class="nx">options</span><span class="p">:</span> <span class="nx">CreateSdkOptions</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Crea un recurso con información del servicio el cual puede ser identificado en el servico de telemetria que escojamos</span>
  <span class="kd">const</span> <span class="nx">resource</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Resource</span><span class="p">({</span>
    <span class="p">[</span><span class="nx">SemanticResourceAttributes</span><span class="p">.</span><span class="nx">SERVICE_NAME</span><span class="p">]:</span> <span class="nx">options</span><span class="p">.</span><span class="nx">serviceName</span><span class="p">,</span>
    <span class="p">[</span><span class="nx">SemanticResourceAttributes</span><span class="p">.</span><span class="nx">SERVICE_VERSION</span><span class="p">]:</span> <span class="nx">options</span><span class="p">.</span><span class="nx">serviceVersion</span><span class="p">,</span>
    <span class="p">[</span><span class="nx">SemanticResourceAttributes</span><span class="p">.</span><span class="nx">SERVICE_NAMESPACE</span><span class="p">]:</span> <span class="dl">'</span><span class="s1">local-machine.spotify-clone</span><span class="dl">'</span>
  <span class="p">})</span>

  <span class="c1">// Crea exportadores para trazas y métricas</span>
  <span class="kd">const</span> <span class="nx">traceExporter</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">OTLPTraceExporter</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">traceExporterOptions</span><span class="p">);</span>
  <span class="kd">const</span> <span class="nx">metricExporter</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">OTLPMetricExporter</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">metricExporterOptions</span><span class="p">)</span>

  <span class="c1">// Inicializa el SDK de OpenTelemetry para Node.js</span>
  <span class="kd">const</span> <span class="nx">sdk</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">NodeSDK</span><span class="p">({</span>
    <span class="nx">resource</span><span class="p">,</span>
    <span class="nx">traceExporter</span><span class="p">,</span>
    <span class="na">contextManager</span><span class="p">:</span> <span class="k">new</span> <span class="nx">AsyncLocalStorageContextManager</span><span class="p">(),</span>
    <span class="na">instrumentations</span><span class="p">:</span> <span class="nx">options</span><span class="p">.</span><span class="nx">instrumentations</span> <span class="k">as</span> <span class="kr">any</span>
  <span class="p">});</span>

  <span class="c1">// Configura un lector de métricas para exportación periódica</span>
  <span class="kd">const</span> <span class="nx">metricReader</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">PeriodicExportingMetricReader</span><span class="p">({</span>
    <span class="na">exporter</span><span class="p">:</span> <span class="nx">metricExporter</span><span class="p">,</span>
    <span class="na">exportIntervalMillis</span><span class="p">:</span> <span class="mi">30000</span><span class="p">,</span> <span class="c1">// Default is 60000ms (60 seconds). Set to 3 seconds for demonstrative purposes only.</span>
  <span class="p">});</span>

  <span class="c1">// Crea un proveedor de medidores para la aplicación</span>
  <span class="kd">const</span> <span class="nx">applicationMeterProvider</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MeterProvider</span><span class="p">({</span>
    <span class="na">resource</span><span class="p">:</span> <span class="nx">resource</span><span class="p">,</span>
  <span class="p">});</span>
  <span class="c1">// Asigna el lector de métricas al proveedor de medidores de la aplicación</span>
  <span class="nx">applicationMeterProvider</span><span class="p">.</span><span class="nx">addMetricReader</span><span class="p">(</span><span class="nx">metricReader</span><span class="p">);</span>

  <span class="c1">// Establece este proveedor como el proveedor global de medidores para la aplicación</span>
  <span class="nx">metrics</span><span class="p">.</span><span class="nx">setGlobalMeterProvider</span><span class="p">(</span><span class="nx">applicationMeterProvider</span><span class="p">);</span>

  <span class="k">return</span> <span class="nx">sdk</span> <span class="c1">// Retorna el SDK configurado</span>
<span class="p">}</span>

<span class="c1">// Función para iniciar OpenTelemetry</span>
<span class="k">export</span> <span class="kd">function</span> <span class="nx">startOpenTelemetry</span><span class="p">(</span><span class="nx">options</span><span class="p">:</span> <span class="nx">CreateSdkOptions</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Crea el SDK de OpenTelemetry llamando a la función createSdk con opciones adicionales</span>
  <span class="kd">const</span> <span class="nx">sdk</span> <span class="o">=</span> <span class="nx">createSdk</span><span class="p">({</span>
    <span class="p">...</span><span class="nx">options</span><span class="p">,</span>
    <span class="na">metricExporterOptions</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">url</span><span class="p">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">OTLP_TRACE_EXPORTER_URL</span><span class="p">,</span><span class="c1">// URL para la exportación de métricas</span>
    <span class="p">},</span>
  <span class="p">})</span>

  <span class="c1">// Función para detener adecuadamente el SDK de OpenTelemetry</span>
  <span class="kd">const</span> <span class="nx">shutdownOtelSdk</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">sdk</span>
      <span class="p">.</span><span class="nx">shutdown</span><span class="p">()</span>
      <span class="p">.</span><span class="nx">then</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">Logger</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">OTEL SDK shut down successfully</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">OpenTelemetrySdk</span><span class="dl">"</span><span class="p">)</span>
        <span class="nx">process</span><span class="p">.</span><span class="nx">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
      <span class="p">})</span>
      <span class="p">.</span><span class="k">catch</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">Logger</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">OTEL SDK failed shut down</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">OpenTelemetrySdk</span><span class="dl">"</span><span class="p">)</span>
        <span class="nx">process</span><span class="p">.</span><span class="nx">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
      <span class="p">})</span>
  <span class="p">}</span>

  <span class="c1">// Manejadores para las señales SIGTERM y SIGINT que llaman a la función de cierre</span>
  <span class="nx">process</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="dl">"</span><span class="s2">SIGTERM</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="nx">shutdownOtelSdk</span><span class="p">())</span>
  <span class="nx">process</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="dl">"</span><span class="s2">SIGINT</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="nx">shutdownOtelSdk</span><span class="p">())</span>
  <span class="c1">// Inicia el SDK de OpenTelemetry</span>
  <span class="nx">sdk</span><span class="p">.</span><span class="nx">start</span><span class="p">()</span>
  <span class="nx">Logger</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">OTEL SDK started successfully</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">startTelemetry</span><span class="dl">"</span><span class="p">)</span>

<span class="p">}</span>
</pre></table></code></div></div><h2 id="ejemplo-de-trazas-con-una-comunicación-entre-microservicios"><span class="mr-2">Ejemplo de trazas con una comunicación entre microservicios</span><a href="#ejemplo-de-trazas-con-una-comunicación-entre-microservicios" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Para ilustrar cómo podemos utilizar OpenTelemetry para mejorar la observabilidad de nuestros microservicios, vamos a utilizar un ejemplo de un clon de Spotify. Tenemos las siguientes aplicaciones:</p><ul><li><code class="language-plaintext highlighter-rouge">mobile-bff</code>: Backend for frontend para aplicaciones móviles, expone los datos mediante GraphQL.<li><code class="language-plaintext highlighter-rouge">music-library-ms</code>: API Rest con la data de artistas, álbumes y canciones.</ul><p><img data-src="https://i.ibb.co/6By7yYt/microservice-2-photo1.png" alt="arquitectura" data-proofer-ignore></p><p>Es un proceso básico que ilustrará una petición de un servicio a otro.</p><p>El código que se mostrará a continuación define la estructura básica y simplificada de las aplicaciones <code class="language-plaintext highlighter-rouge">mobile-bff</code> y <code class="language-plaintext highlighter-rouge">music-library-ms</code>, las cuales simularán la librería musical de Spotify.</p><blockquote><p>Si quieres ver en detalle el codigo puedes consultar el <a href="https://github.com/nullpointer-excelsior/microservices-architecture-nestjs">repositorio</a></p></blockquote><h2 id="servicio-mobilebff-spotify-clone"><span class="mr-2">Servicio MobileBFF Spotify clone</span><a href="#servicio-mobilebff-spotify-clone" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Definimos las clases necesarias para levantar nuestro servicio GraphQL.</p><div class="language-typescript highlighter-rouge"><div class="code-header"> <span data-label-text="TypeScript"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="¡Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
</pre><td class="rouge-code"><pre><span class="c1">// Model de Artist Graphql</span>
<span class="p">@</span><span class="nd">ObjectType</span><span class="p">()</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">Artist</span> <span class="p">{</span>

    <span class="p">@</span><span class="nd">Field</span><span class="p">({</span> <span class="na">nullable</span><span class="p">:</span> <span class="kc">true</span> <span class="p">})</span>
    <span class="nx">id</span><span class="p">:</span> <span class="kr">string</span><span class="p">;</span>

    <span class="p">@</span><span class="nd">Field</span><span class="p">()</span>
    <span class="nx">name</span><span class="p">:</span> <span class="kr">string</span><span class="p">;</span>

    <span class="p">@</span><span class="nd">Field</span><span class="p">({</span> <span class="na">nullable</span><span class="p">:</span> <span class="kc">true</span> <span class="p">})</span>
    <span class="nx">photo</span><span class="p">?:</span> <span class="kr">string</span><span class="p">;</span>

    <span class="p">@</span><span class="nd">Field</span><span class="p">({</span> <span class="na">nullable</span><span class="p">:</span> <span class="kc">true</span> <span class="p">})</span>
    <span class="nx">biography</span><span class="p">?:</span> <span class="kr">string</span><span class="p">;</span>

    <span class="p">@</span><span class="nd">Field</span><span class="p">(</span><span class="kd">type</span> <span class="o">=&gt;</span><span class="p">[</span><span class="nx">Album</span><span class="p">],</span> <span class="p">{</span> <span class="na">nullable</span><span class="p">:</span> <span class="dl">'</span><span class="s1">itemsAndList</span><span class="dl">'</span> <span class="p">})</span>
    <span class="nx">albums</span><span class="p">?:</span> <span class="nx">Album</span><span class="p">[]</span>

<span class="p">}</span>

<span class="c1">// Resolver de Artist</span>
<span class="p">@</span><span class="nd">Resolver</span><span class="p">(</span><span class="k">of</span> <span class="o">=&gt;</span> <span class="nx">Artist</span><span class="p">)</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">ArtistResolver</span> <span class="p">{</span>

    <span class="kd">constructor</span><span class="p">(</span>
        <span class="k">private</span> <span class="nx">artistService</span><span class="p">:</span> <span class="nx">ArtistService</span><span class="p">,</span>
        <span class="k">private</span> <span class="nx">albumService</span><span class="p">:</span> <span class="nx">AlbumService</span>
    <span class="p">)</span> <span class="p">{}</span>

    <span class="p">@</span><span class="nd">Span</span><span class="p">(</span><span class="dl">"</span><span class="s2">ArtistResolver/query/artistById</span><span class="dl">"</span><span class="p">)</span>
    <span class="p">@</span><span class="nd">Query</span><span class="p">(</span><span class="nx">returns</span> <span class="o">=&gt;</span> <span class="nx">Artist</span><span class="p">)</span>
    <span class="nx">artistById</span><span class="p">(@</span><span class="nd">Args</span><span class="p">(</span><span class="dl">'</span><span class="s1">id</span><span class="dl">'</span><span class="p">)</span> <span class="nx">id</span><span class="p">:</span> <span class="kr">string</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">artistService</span><span class="p">.</span><span class="nx">findById</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="p">@</span><span class="nd">Span</span><span class="p">(</span><span class="dl">"</span><span class="s2">ArtistResolver/query/artists</span><span class="dl">"</span><span class="p">)</span>
    <span class="p">@</span><span class="nd">Query</span><span class="p">(</span><span class="nx">returns</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="nx">Artist</span><span class="p">])</span>
    <span class="nx">artists</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">artistService</span><span class="p">.</span><span class="nx">findAll</span><span class="p">()</span>
    <span class="p">}</span>

    <span class="p">@</span><span class="nd">Span</span><span class="p">(</span><span class="dl">"</span><span class="s2">ArtistResolver/field/album</span><span class="dl">"</span><span class="p">)</span>
    <span class="p">@</span><span class="nd">ResolveField</span><span class="p">()</span>
    <span class="k">async</span> <span class="nx">albums</span><span class="p">(@</span><span class="nd">Parent</span><span class="p">()</span> <span class="nx">artist</span><span class="p">:</span> <span class="nx">Artist</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">albumService</span><span class="p">.</span><span class="nx">findByArtistId</span><span class="p">(</span><span class="nx">artist</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span>
    <span class="p">}</span>

<span class="p">}</span>
</pre></table></code></div></div><div class="language-typescript highlighter-rouge"><div class="code-header"> <span data-label-text="TypeScript"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="¡Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
</pre><td class="rouge-code"><pre><span class="c1">// cliente http para conexion con el microservicio music-library-ms</span>
<span class="p">@</span><span class="nd">Injectable</span><span class="p">()</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">MusicLibraryCLient</span> <span class="p">{</span>

    <span class="k">private</span> <span class="nx">musiclibraryUrl</span> <span class="o">=</span> <span class="kc">null</span>

    <span class="kd">constructor</span><span class="p">(</span>
        <span class="k">private</span> <span class="k">readonly</span> <span class="nx">http</span><span class="p">:</span> <span class="nx">HttpService</span><span class="p">,</span>
        <span class="k">private</span> <span class="k">readonly</span> <span class="nx">config</span><span class="p">:</span> <span class="nx">ConfigService</span>
    <span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">musiclibraryUrl</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">"</span><span class="s2">MOBILE_BFF_MUSIC_LIBRARY_API</span><span class="dl">"</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="p">@</span><span class="nd">Span</span><span class="p">(</span><span class="dl">"</span><span class="s2">MusicLibraryHttpClient/GET</span><span class="dl">"</span><span class="p">)</span>
    <span class="kd">get</span><span class="o">&lt;</span><span class="nx">T</span> <span class="o">=</span> <span class="kr">any</span><span class="o">&gt;</span><span class="p">(</span><span class="nx">endopoint</span><span class="p">:</span> <span class="kr">string</span><span class="p">,</span> <span class="nx">config</span><span class="p">?:</span> <span class="nx">AxiosRequestConfig</span><span class="p">):</span> <span class="nx">Observable</span><span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;</span> <span class="p">{</span>
        <span class="kd">const</span> <span class="nx">url</span> <span class="o">=</span> <span class="s2">`</span><span class="p">${</span><span class="k">this</span><span class="p">.</span><span class="nx">musiclibraryUrl</span><span class="p">}</span><span class="s2">/</span><span class="p">${</span><span class="nx">endopoint</span><span class="p">}</span><span class="s2">`</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">http</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="nx">config</span><span class="p">).</span><span class="nx">pipe</span><span class="p">(</span>
            <span class="nx">map</span><span class="p">(</span><span class="nx">res</span> <span class="o">=&gt;</span> <span class="nx">res</span><span class="p">.</span><span class="nx">data</span><span class="p">)</span>
        <span class="p">);</span>
    <span class="p">}</span>

<span class="p">}</span>
<span class="c1">// componente de tipo service para obtener los artistas de music-library-ms</span>
<span class="p">@</span><span class="nd">Injectable</span><span class="p">()</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">ArtistService</span> <span class="p">{</span>

  <span class="kd">constructor</span><span class="p">(</span><span class="k">private</span> <span class="nx">client</span><span class="p">:</span> <span class="nx">MusicLibraryCLient</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>

  <span class="p">@</span><span class="nd">Span</span><span class="p">(</span><span class="dl">"</span><span class="s2">ArtistService/findById</span><span class="dl">"</span><span class="p">)</span>
  <span class="nx">findById</span><span class="p">(</span><span class="nx">id</span><span class="p">:</span> <span class="kr">string</span><span class="p">):</span> <span class="nx">Observable</span><span class="o">&lt;</span><span class="nx">ArtistModel</span><span class="p">[]</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">client</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="s2">`artists/</span><span class="p">${</span><span class="nx">id</span><span class="p">}</span><span class="s2">`</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="p">@</span><span class="nd">Span</span><span class="p">(</span><span class="dl">"</span><span class="s2">ArtistService/findAll</span><span class="dl">"</span><span class="p">)</span>
  <span class="nx">findAll</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">client</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="s2">`artists`</span><span class="p">)</span>
  <span class="p">}</span>

<span class="p">}</span>
</pre></table></code></div></div><blockquote><p>Se ignoran las configuraciones de módulos, ya que salen del objetivo del artículo.</p></blockquote><h2 id="microservicio-music-library-spotify-clone"><span class="mr-2">Microservicio Music Library Spotify Clone</span><a href="#microservicio-music-library-spotify-clone" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Nuestro Microservicio <code class="language-plaintext highlighter-rouge">music-library-ms</code> es una API Rest simple.</p><div class="language-typescript highlighter-rouge"><div class="code-header"> <span data-label-text="TypeScript"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="¡Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
</pre><td class="rouge-code"><pre><span class="c1">// artist controller</span>
<span class="p">@</span><span class="nd">Controller</span><span class="p">(</span><span class="dl">'</span><span class="s1">artists</span><span class="dl">'</span><span class="p">)</span>
<span class="p">@</span><span class="nd">ApiTags</span><span class="p">(</span><span class="dl">'</span><span class="s1">Artists</span><span class="dl">'</span><span class="p">)</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">ArtistController</span> <span class="p">{</span>

  <span class="kd">constructor</span><span class="p">(</span><span class="k">private</span> <span class="nx">artistService</span><span class="p">:</span> <span class="nx">ArtistService</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>

  <span class="p">@</span><span class="nd">Get</span><span class="p">()</span>
  <span class="p">@</span><span class="nd">ApiOperation</span><span class="p">({</span> <span class="na">summary</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Get all artists</span><span class="dl">'</span> <span class="p">})</span>
  <span class="p">@</span><span class="nd">ApiResponse</span><span class="p">({</span> <span class="na">status</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span> <span class="na">description</span><span class="p">:</span> <span class="dl">'</span><span class="s1">All artists</span><span class="dl">'</span><span class="p">,</span> <span class="na">type</span><span class="p">:</span> <span class="p">[</span><span class="nx">ArtistModel</span><span class="p">]</span> <span class="p">})</span>
  <span class="k">async</span> <span class="nx">getAllArtists</span><span class="p">():</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">ArtistModel</span><span class="p">[]</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">artistService</span><span class="p">.</span><span class="nx">findAll</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="p">@</span><span class="nd">Get</span><span class="p">(</span><span class="dl">'</span><span class="s1">:id</span><span class="dl">'</span><span class="p">)</span>
  <span class="p">@</span><span class="nd">ApiOperation</span><span class="p">({</span> <span class="na">summary</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Get an artist by ID</span><span class="dl">'</span> <span class="p">})</span>
  <span class="p">@</span><span class="nd">ApiParam</span><span class="p">({</span> <span class="na">name</span><span class="p">:</span> <span class="dl">'</span><span class="s1">id</span><span class="dl">'</span><span class="p">,</span> <span class="na">description</span><span class="p">:</span> <span class="dl">'</span><span class="s1">The ID of the artist</span><span class="dl">'</span> <span class="p">})</span>
  <span class="p">@</span><span class="nd">ApiResponse</span><span class="p">({</span> <span class="na">status</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span> <span class="na">description</span><span class="p">:</span> <span class="dl">'</span><span class="s1">The artist</span><span class="dl">'</span><span class="p">,</span> <span class="na">type</span><span class="p">:</span> <span class="nx">ArtistModel</span> <span class="p">})</span>
  <span class="p">@</span><span class="nd">ApiResponse</span><span class="p">({</span> <span class="na">status</span><span class="p">:</span> <span class="mi">404</span><span class="p">,</span> <span class="na">description</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Artist not found</span><span class="dl">'</span> <span class="p">})</span>
  <span class="k">async</span> <span class="nx">getArtist</span><span class="p">(@</span><span class="nd">Param</span><span class="p">(</span><span class="dl">'</span><span class="s1">id</span><span class="dl">'</span><span class="p">)</span> <span class="nx">id</span><span class="p">:</span> <span class="kr">string</span><span class="p">):</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">ArtistModel</span> <span class="o">|</span> <span class="kc">undefined</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">artistService</span><span class="p">.</span><span class="nx">findById</span><span class="p">(</span><span class="nx">id</span><span class="p">);</span>
  <span class="p">}</span>

<span class="p">}</span>

<span class="c1">// artist model</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">ArtistModel</span> <span class="p">{</span>

  <span class="p">@</span><span class="nd">IsUUI</span><span class="p">()</span>
  <span class="p">@</span><span class="nd">IsNotEmpty</span><span class="p">()</span>
  <span class="p">@</span><span class="nd">ApiProperty</span><span class="p">({</span> <span class="na">description</span><span class="p">:</span> <span class="dl">'</span><span class="s1">The ID of the artist</span><span class="dl">'</span> <span class="p">})</span>
  <span class="nx">id</span><span class="p">:</span> <span class="kr">string</span><span class="p">;</span>

  <span class="p">@</span><span class="nd">IsString</span><span class="p">()</span>
  <span class="p">@</span><span class="nd">ApiProperty</span><span class="p">({</span> <span class="na">description</span><span class="p">:</span> <span class="dl">'</span><span class="s1">The name of the artist</span><span class="dl">'</span> <span class="p">})</span>
  <span class="nx">name</span><span class="p">:</span> <span class="kr">string</span><span class="p">;</span>

  <span class="p">@</span><span class="nd">IsString</span><span class="p">()</span>
  <span class="p">@</span><span class="nd">ApiProperty</span><span class="p">({</span> <span class="na">description</span><span class="p">:</span> <span class="dl">'</span><span class="s1">The photo of the artist</span><span class="dl">'</span> <span class="p">})</span>
  <span class="nx">photo</span><span class="p">:</span> <span class="kr">string</span><span class="p">;</span>

  <span class="p">@</span><span class="nd">IsString</span><span class="p">()</span>
  <span class="p">@</span><span class="nd">ApiProperty</span><span class="p">({</span> <span class="na">description</span><span class="p">:</span> <span class="dl">'</span><span class="s1">The biography of the artist</span><span class="dl">'</span> <span class="p">})</span>
  <span class="nx">biography</span><span class="p">:</span> <span class="kr">string</span><span class="p">;</span>

<span class="p">}</span>

<span class="c1">// ArtistService</span>
<span class="p">@</span><span class="nd">Injectable</span><span class="p">()</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">ArtistService</span> <span class="p">{</span>

    <span class="kd">constructor</span><span class="p">(@</span><span class="nd">InjectRepository</span><span class="p">(</span><span class="nx">Artist</span><span class="p">)</span> <span class="k">private</span> <span class="nx">repository</span><span class="p">:</span> <span class="nx">Repository</span><span class="o">&lt;</span><span class="nx">Artist</span><span class="o">&gt;</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>

    <span class="p">@</span><span class="nd">Span</span><span class="p">(</span><span class="dl">"</span><span class="s2">ArtistService/findAll</span><span class="dl">"</span><span class="p">)</span>
    <span class="nx">findAll</span><span class="p">():</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">ArtistModel</span><span class="p">[]</span><span class="o">&gt;</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">repository</span><span class="p">.</span><span class="nx">find</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="p">@</span><span class="nd">Span</span><span class="p">(</span><span class="dl">"</span><span class="s2">ArtistService/findById</span><span class="dl">"</span><span class="p">)</span>
    <span class="p">@</span><span class="nd">NotFoundExceptionIfUndefined</span><span class="p">(</span><span class="dl">'</span><span class="s1">Artist not found</span><span class="dl">'</span><span class="p">)</span>
    <span class="nx">findById</span><span class="p">(</span><span class="nx">id</span><span class="p">:</span> <span class="kr">string</span><span class="p">):</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">ArtistModel</span><span class="o">&gt;</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">repository</span><span class="p">.</span><span class="nx">findOneBy</span><span class="p">({</span> <span class="nx">id</span> <span class="p">});</span>
    <span class="p">}</span>

<span class="p">}</span>

<span class="c1">// Artist ORM Entity</span>
<span class="p">@</span><span class="nd">Entity</span><span class="p">()</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">Artist</span> <span class="p">{</span>

  <span class="p">@</span><span class="nd">PrimaryGeneratedColumn</span><span class="p">(</span><span class="dl">"</span><span class="s2">uuid</span><span class="dl">"</span><span class="p">)</span>
  <span class="nx">id</span><span class="p">:</span> <span class="kr">string</span><span class="p">;</span>

  <span class="p">@</span><span class="nd">Column</span><span class="p">()</span>
  <span class="nx">name</span><span class="p">:</span> <span class="kr">string</span><span class="p">;</span>

  <span class="p">@</span><span class="nd">Column</span><span class="p">()</span>
  <span class="nx">photo</span><span class="p">:</span> <span class="kr">string</span><span class="p">;</span>

  <span class="p">@</span><span class="nd">Column</span><span class="p">()</span>
  <span class="nx">biography</span><span class="p">:</span> <span class="kr">string</span><span class="p">;</span>

  <span class="p">@</span><span class="nd">OneToMany</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="nx">Song</span><span class="p">,</span> <span class="nx">song</span> <span class="o">=&gt;</span> <span class="nx">song</span><span class="p">.</span><span class="nx">artist</span><span class="p">)</span>
  <span class="nx">songs</span><span class="p">:</span> <span class="nx">Song</span><span class="p">[]</span>

  <span class="p">@</span><span class="nd">OneToMany</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="nx">Album</span><span class="p">,</span> <span class="nx">album</span> <span class="o">=&gt;</span> <span class="nx">album</span><span class="p">.</span><span class="nx">artist</span><span class="p">)</span>
  <span class="nx">albums</span><span class="p">:</span> <span class="nx">Album</span><span class="p">[]</span>

<span class="p">}</span>

</pre></table></code></div></div><h2 id="iniciando-instrumentación-de-microservicios"><span class="mr-2">Iniciando instrumentación de microservicios</span><a href="#iniciando-instrumentación-de-microservicios" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>La instrumentación debe instanciarse en el punto de entrada de la aplicación. Debemos hacer llamado de la función <code class="language-plaintext highlighter-rouge">startOpenTelemetry()</code> en la ejecución del archivo <code class="language-plaintext highlighter-rouge">main.ts</code>. Debemos iniciar esta función antes del método <code class="language-plaintext highlighter-rouge">bootstrap()</code> como en el siguiente ejemplo:</p><h3 id="mobile-bff-appsmobile-bffmaints"><span class="mr-2">mobile-bff <code class="language-plaintext highlighter-rouge">apps/mobile-bff/main.ts</code></span><a href="#mobile-bff-appsmobile-bffmaints" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><div class="language-typescript highlighter-rouge"><div class="code-header"> <span data-label-text="TypeScript"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="¡Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre><span class="c1">// MOBILE-BFF Application</span>
<span class="k">async</span> <span class="kd">function</span> <span class="nx">bootstrap</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">NestFactory</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="nx">MusicLibraryMsModule</span><span class="p">);</span>
  <span class="c1">// server implementation and more code...</span>
<span class="p">}</span>

<span class="nx">startOpenTelemetry</span><span class="p">({</span>
  <span class="na">serviceName</span><span class="p">:</span> <span class="dl">"</span><span class="s2">mobile-bff</span><span class="dl">"</span><span class="p">,</span>
  <span class="na">serviceVersion</span><span class="p">:</span> <span class="dl">"</span><span class="s2">1.0</span><span class="dl">"</span><span class="p">,</span>
  <span class="na">instrumentations</span><span class="p">:</span> <span class="p">[</span>
    <span class="k">new</span> <span class="nx">HttpInstrumentation</span><span class="p">(),</span> <span class="c1">// trazas http</span>
    <span class="k">new</span> <span class="nx">ExpressInstrumentation</span><span class="p">({</span> <span class="c1">// trazas express</span>
      <span class="na">ignoreLayersType</span><span class="p">:</span> <span class="p">[</span><span class="nx">ExpressLayerType</span><span class="p">.</span><span class="nx">REQUEST_HANDLER</span><span class="p">,</span> <span class="nx">ExpressLayerType</span><span class="p">.</span><span class="nx">MIDDLEWARE</span><span class="p">]</span> <span class="c1">// se ignora trazas provenientes de middleware y request handlre de express</span>
    <span class="p">}),</span>
  <span class="p">],</span>
<span class="p">})</span>

<span class="nx">bootstrap</span><span class="p">();</span>
</pre></table></code></div></div><h3 id="music-library-ms-appsmusic-library-msmaints"><span class="mr-2">music-library-ms <code class="language-plaintext highlighter-rouge">apps/music-library-ms/main.ts</code></span><a href="#music-library-ms-appsmusic-library-msmaints" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><div class="language-typescript highlighter-rouge"><div class="code-header"> <span data-label-text="TypeScript"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="¡Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre><td class="rouge-code"><pre><span class="c1">// MusicLibraryMS microservice</span>
<span class="k">async</span> <span class="kd">function</span> <span class="nx">bootstrap</span><span class="p">()</span> <span class="p">{</span>

  <span class="kd">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">NestFactory</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="nx">MusicLibraryMsModule</span><span class="p">);</span>
  <span class="c1">// server implementation and more code...</span>

<span class="p">}</span>

<span class="nx">startOpenTelemetry</span><span class="p">({</span>
  <span class="na">serviceName</span><span class="p">:</span> <span class="dl">"</span><span class="s2">music-library-ms</span><span class="dl">"</span><span class="p">,</span>
  <span class="na">serviceVersion</span><span class="p">:</span> <span class="dl">"</span><span class="s2">1.0</span><span class="dl">"</span><span class="p">,</span>
  <span class="na">instrumentations</span><span class="p">:</span> <span class="p">[</span>
    <span class="k">new</span> <span class="nx">HttpInstrumentation</span><span class="p">(),</span>
    <span class="k">new</span> <span class="nx">PgInstrumentation</span><span class="p">(),</span> <span class="c1">// trazas de postgres</span>
    <span class="k">new</span> <span class="nx">ExpressInstrumentation</span><span class="p">({</span>
      <span class="na">ignoreLayersType</span><span class="p">:</span> <span class="p">[</span><span class="nx">ExpressLayerType</span><span class="p">.</span><span class="nx">REQUEST_HANDLER</span><span class="p">,</span> <span class="nx">ExpressLayerType</span><span class="p">.</span><span class="nx">MIDDLEWARE</span><span class="p">]</span>
    <span class="p">}),</span>
  <span class="p">],</span>
<span class="p">})</span>

<span class="nx">bootstrap</span><span class="p">();</span>
</pre></table></code></div></div><p>Tanto <code class="language-plaintext highlighter-rouge">mobile-bff</code> como <code class="language-plaintext highlighter-rouge">music-library-ms</code> instrumentarán <code class="language-plaintext highlighter-rouge">HttpInstrumentation</code> y <code class="language-plaintext highlighter-rouge">ExpressInstrumentation</code>. Con esto lograremos que OpenTelemetry pueda asociar cualquier petición entre los 2 en una misma traza con una jerarquía incluida. <code class="language-plaintext highlighter-rouge">music-library-ms</code> instrumentará <code class="language-plaintext highlighter-rouge">PgInstrumentation</code> para obtener información sobre el motor PostgreSQL.</p><h2 id="customizando-trazas-con-spans"><span class="mr-2">Customizando Trazas con Spans</span><a href="#customizando-trazas-con-spans" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Un “Span” representa una porción de tiempo durante la cual una operación específica ocurre en una aplicación. Por ejemplo, cuando se inicia una solicitud HTTP en un servicio y se completa, también contienen información relevante sobre el tiempo que tomó la operación, metadatos contextualizados (como identificadores de servicio, identificadores de usuario, etc.), así como también pueden tener relaciones padre-hijo, lo que permite visualizar cómo las operaciones se relacionan entre sí en un entorno distribuido.</p><p>Para implementar Span podemos utilizar la librería <code class="language-plaintext highlighter-rouge">nestjs-otel</code>, la cual nos proporciona un conjunto de anotaciones y servicios de NestJS para instrumentar de forma fácil y limpia nuestras aplicaciones.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="¡Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>npm <span class="nb">install </span>nestjs-otel
</pre></table></code></div></div><p>Ahora en cualquier método podemos hacer uso del decorador <code class="language-plaintext highlighter-rouge">@Span</code>.</p><div class="language-typescript highlighter-rouge"><div class="code-header"> <span data-label-text="TypeScript"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="¡Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="p">@</span><span class="nd">Span</span><span class="p">(</span><span class="dl">"</span><span class="s2">ArtistService/findById</span><span class="dl">"</span><span class="p">)</span>
<span class="nx">findById</span><span class="p">(</span><span class="nx">id</span><span class="p">:</span> <span class="kr">string</span><span class="p">):</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">ArtistModel</span><span class="o">&gt;</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">repository</span><span class="p">.</span><span class="nx">findOneBy</span><span class="p">({</span> <span class="nx">id</span> <span class="p">});</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Además, podemos agregar atributos a nuestras trazas para proporcionar más contexto sobre las operaciones que estamos rastreando. Por ejemplo, podemos agregar más información o metadata a nestras trazas en <code class="language-plaintext highlighter-rouge">ArtistService</code> de la siguiente manera:</p><div class="language-typescript highlighter-rouge"><div class="code-header"> <span data-label-text="TypeScript"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="¡Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
</pre><td class="rouge-code"><pre>
<span class="p">@</span><span class="nd">Injectable</span><span class="p">()</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">ArtistService</span> <span class="p">{</span>

    <span class="kd">constructor</span><span class="p">(</span><span class="k">private</span> <span class="k">readonly</span> <span class="nx">traceService</span><span class="p">:</span> <span class="nx">TraceService</span><span class="p">)</span> <span class="p">{}</span>

    <span class="c1">// atributos mediante decorador</span>
    <span class="p">@</span><span class="nd">Span</span><span class="p">(</span><span class="dl">"</span><span class="s2">ArtistService/findById</span><span class="dl">"</span><span class="p">,</span> <span class="p">{</span> <span class="na">attributes</span><span class="p">:</span> <span class="p">{</span> <span class="na">foo</span><span class="p">:</span> <span class="dl">'</span><span class="s1">bar</span><span class="dl">'</span> <span class="p">}})</span>
    <span class="nx">findById</span><span class="p">(</span><span class="nx">id</span><span class="p">:</span> <span class="kr">string</span><span class="p">):</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">ArtistModel</span><span class="o">&gt;</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">repository</span><span class="p">.</span><span class="nx">findOneBy</span><span class="p">({</span> <span class="nx">id</span> <span class="p">});</span>
    <span class="p">}</span>

    <span class="c1">// atributos mediante service</span>
    <span class="k">async</span> <span class="nx">save</span><span class="p">(</span><span class="nx">artist</span><span class="p">:</span> <span class="nx">CreateArtistRequest</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="nx">currentSpan</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">traceService</span><span class="p">.</span><span class="nx">getSpan</span><span class="p">();</span> <span class="c1">// --&gt; retrives current span, comes from http or @Span</span>
      <span class="kd">const</span> <span class="nx">saved</span> <span class="o">=</span> <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">repository</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="nx">artist</span><span class="p">)</span>
      <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">doSomething</span><span class="p">();</span>
      <span class="nx">currentSpan</span><span class="p">.</span><span class="nx">addEvent</span><span class="p">(</span><span class="dl">'</span><span class="s1">event 1</span><span class="dl">'</span><span class="p">);</span>
      <span class="nx">currentSpan</span><span class="p">.</span><span class="nx">end</span><span class="p">();</span> <span class="c1">// current span end</span>
      <span class="kd">const</span> <span class="nx">span</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">traceService</span><span class="p">.</span><span class="nx">startSpan</span><span class="p">(</span><span class="dl">'</span><span class="s1">sub_span</span><span class="dl">'</span><span class="p">);</span> <span class="c1">// start new span</span>
      <span class="nx">span</span><span class="p">.</span><span class="nx">setAttributes</span><span class="p">({</span> <span class="na">userId</span><span class="p">:</span> <span class="mi">1</span> <span class="p">});</span>
      <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">doSomethingElse</span><span class="p">();</span>
      <span class="nx">span</span><span class="p">.</span><span class="nx">end</span><span class="p">();</span>
      <span class="k">return</span> <span class="nx">saved</span>
    <span class="p">}</span>

    <span class="k">async</span> <span class="nx">doSomething</span><span class="p">()</span> <span class="p">{</span>
      <span class="c1">// some random operation</span>
    <span class="p">}</span>

<span class="p">}</span>

</pre></table></code></div></div><h2 id="ejecución-y-pruebas-de-trazas-distribuidas"><span class="mr-2">Ejecución y Pruebas de trazas distribuidas</span><a href="#ejecución-y-pruebas-de-trazas-distribuidas" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Finalizando con la implementación de OpenTelemetry, es hora de realizar un par de pruebas. Todo el código anterior con mayor detalle está en el siguiente <a href="https://github.com/nullpointer-excelsior/microservices-architecture-nestjs">repositorio</a>. Ahora sigue los siguientes pasos para probar el sistema:</p><blockquote><p>Necesitarás tener Docker corriendo en tu máquina local.</p></blockquote><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="¡Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="c"># Clonar el repositorio</span>
git clone https://github.com/nullpointer-excelsior/microservices-architecture-nestjs

<span class="c"># Instalar dependencias</span>
<span class="nb">cd </span>microservices-architecture-nestjs/
npm <span class="nb">install</span>
</pre></table></code></div></div><p>Ahora necesitaremos levantar la infraestructura y las aplicaciones:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="¡Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="c"># Levantar infraestructura</span>
npm run start:infra 
<span class="c"># Iniciar mobile-bff</span>
npm run start:mobile-bff
<span class="c"># Iniciar music-library-ms</span>
npm run start:music-library
</pre></table></code></div></div><p>El comando <code class="language-plaintext highlighter-rouge">npm run start:infra</code> levantará también a Jeager UI. Ahora, si todo sale bien, tendrás 2 aplicaciones NestJs ejecutándose más la aplicación Jeager UI:</p><ul><li><code class="language-plaintext highlighter-rouge">mobile-bff</code>: En la URL http://localhost:3014/graphql encontrarás el playground de GraphQL con el cual podrás ejecutar consultas.<li><code class="language-plaintext highlighter-rouge">music-library-ms</code>: En la URL http://localhost:3011/api encontrarás la definición de la API con Swagger con la que podrás interactuar con la API directamente.<li><code class="language-plaintext highlighter-rouge">Jeager UI</code>: En la URL http://localhost:16686 encontrarás Jaeger UI. Aquí es donde visualizaremos las trazas de las aplicaciones.</ul><h3 id="visualizando-nuestra-primera-traza"><span class="mr-2">Visualizando nuestra primera traza</span><a href="#visualizando-nuestra-primera-traza" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Nos dirigimos a http://localhost:3014/graphql y realizaremos la siguiente query.</p><pre><code class="language-gql">query {
  artists {
    name,
    albums {
      photo,
      songs {
        title,
      }
    }
  }
}
</code></pre><p>como se muestra en la imagen <img data-src="https://i.ibb.co/Z8zwdn7/Screenshot-2023-11-27-at-15-46-41.png" alt="i1" data-proofer-ignore></p><p>En este caso, no nos devolverá datos, pero habrá hecho una petición a <code class="language-plaintext highlighter-rouge">music-library-ms</code>, con esto nos basta.</p><h3 id="visualizando-trazas-en-jeager-ui"><span class="mr-2">Visualizando trazas en Jeager UI</span><a href="#visualizando-trazas-en-jeager-ui" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Nos dirigimos a http://localhost:16686 y en el buscador de servicios podremos filtrar nuestras trazas. En este caso, escogeremos <code class="language-plaintext highlighter-rouge">mobile-bff</code>. Si no vemos <code class="language-plaintext highlighter-rouge">mobile-bff</code> o <code class="language-plaintext highlighter-rouge">music-library-ms</code>, esperamos unos minutos y refrescamos.</p><p><img data-src="https://i.ibb.co/qD97CYM/Screenshot-2023-11-27-at-15-47-15.png" alt="i2" data-proofer-ignore></p><p>Ahora veremos las distintas trazas que llegaron a Jeager UI. Escogeremos la que tenga más spans asociados y expandiremos.</p><p><img data-src="https://i.ibb.co/n3XH7Hd/Screenshot-2023-11-27-at-16-07-14.png" alt="i3" data-proofer-ignore></p><p>Ahora podemos ver una jerarquía de spans realizados por ambas aplicaciones donde nos da una apreciación de tiempo como de atributos que pudiera contener las trazas.</p><p><img data-src="https://i.ibb.co/LR0S8Xd/Screenshot-2023-11-27-at-15-47-00.png" alt="i4" data-proofer-ignore></p><p>Toda la información que enviamos es personalizable. Deberás consultar la documentación de <a href="https://opentelemetry.io/docs/getting-started/dev/">OpenTelemetry</a> o de la instrumentación en específico. Por ejemplo, aquí podemos visualizar la query realizada por <code class="language-plaintext highlighter-rouge">music-library-ms</code>.</p><p><img data-src="https://i.ibb.co/1nxkV3S/Screenshot-2023-11-27-at-15-48-05.png" alt="i5" data-proofer-ignore></p><h2 id="conclusión"><span class="mr-2">Conclusión</span><a href="#conclusión" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>La implementación de trazas distribuidas con OpenTelemetry nos dará una ventaja al momento de resolver problemas en entornos distribuidos. Antes de diseñar microservicios o cualquier aplicación donde el entorno producctivo sea realmente crítico, debemos considerar cómo vamos a hacer seguimiento de estos sistemas. En este artículo abordamos solo el caso de trazas, pero la observabilidad en la ingeniería de software nos ayudará a:</p><ul><li><strong>Monitoreo de salud</strong>: Evaluar el estado de los componentes distribuidos.<li><strong>Identificar cuellos de botella</strong>: Encontrar áreas de rendimiento deficiente.<li><strong>Optimización de recursos</strong>: Ajustar asignación de CPU, memoria, etc.<li><strong>Seguimiento y trazabilidad</strong>: Rastrear flujo de datos entre servicios.<li><strong>Detección de problemas en tiempo real</strong>: Configurar alertas para responder rápidamente.<li><strong>Análisis de tendencias</strong>: Identificar patrones y comportamientos históricos de los usuarios para toma de decisiones.<li><strong>Automatización de respuestas</strong>: Tomar decisiones automáticas según la demanda.<li><strong>Optimización de la experiencia del usuario</strong>: Mejorar rendimiento según interacciones.<li><strong>Seguridad y detección de anomalías</strong>: Identificar posibles ataques o brechas.<li><strong>Evaluación del rendimiento a largo plazo</strong>: Analizar para mejorar la arquitectura.</ul><p>La observabilidad es un aspecto crucial para el desarrollo y la operación de microservicios. En este artículo vimos solo la capacidad de las trazas. OpenTelemetry nos proporciona las herramientas necesarias para recopilar y gestionar la telemetría de nuestras aplicaciones, lo que nos permite obtener una visión completa de nuestras aplicaciones. Con OpenTelemetry, podemos mejorar la calidad y el rendimiento de nuestras aplicaciones y resolver los problemas de manera más eficiente.</p><h2 id="github-repository"><span class="mr-2"><a href="https://github.com/nullpointer-excelsior/microservices-architecture-nestjs/">Github repository</a></span><a href="#github-repository" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><h3 id="meme-de-cortesía"><span class="mr-2">Meme de cortesía:</span><a href="#meme-de-cortesía" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p><img data-src="https://i.ibb.co/qdG0XN6/Screenshot-2023-11-28-at-11-50-32.png" alt="meme" data-proofer-ignore></p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='//categories/microservicios-observabilidad-opentelemetry-jeager-trazas/'>Microservicios,Observabilidad,OpenTelemetry,Jeager,Trazas</a>, <a href='//categories/distribuidas/'>distribuidas</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="//tags/microservicios-observabilidad-opentelemetry-jeager-trazas/" class="post-tag no-text-decoration" >microservicios,observabilidad,opentelemetry,jeager,trazas</a> <a href="//tags/distribuidas/" class="post-tag no-text-decoration" >distribuidas</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> Esta entrada está licenciada bajo <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> por el autor.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Compartir</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Microservicios+2+Observabilidad+en+NestJs%2C+un+ejemplo+pr%C3%A1ctico+de+trazas+distribuidas+-+Nullpointer+Excelsior&url=https%3A%2F%2Fnullpointer-excelsior.github.io%2Fposts%2Fmicroservicios-observabilidad-en-microservicios-un-ejemplo-practico-de-trazas-distribuidas%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Microservicios+2+Observabilidad+en+NestJs%2C+un+ejemplo+pr%C3%A1ctico+de+trazas+distribuidas+-+Nullpointer+Excelsior&u=https%3A%2F%2Fnullpointer-excelsior.github.io%2Fposts%2Fmicroservicios-observabilidad-en-microservicios-un-ejemplo-practico-de-trazas-distribuidas%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Fnullpointer-excelsior.github.io%2Fposts%2Fmicroservicios-observabilidad-en-microservicios-un-ejemplo-practico-de-trazas-distribuidas%2F&text=Microservicios+2+Observabilidad+en+NestJs%2C+un+ejemplo+pr%C3%A1ctico+de+trazas+distribuidas+-+Nullpointer+Excelsior" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Fnullpointer-excelsior.github.io%2Fposts%2Fmicroservicios-observabilidad-en-microservicios-un-ejemplo-practico-de-trazas-distribuidas%2F" data-toggle="tooltip" data-placement="top" title="Linkedin" target="_blank" rel="noopener" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copiar enlace" data-title-succeed="¡Enlace copiado!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Actualizado recientemente</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/microservicios-observabilidad-en-microservicios-un-ejemplo-practico-de-trazas-distribuidas/">Microservicios 2 Observabilidad en NestJs, un ejemplo práctico de trazas distribuidas</a><li><a href="/posts/realtime-with-reactive-programming/">Aplicaciones en tiempo real con programación reactiva</a><li><a href="/posts/tranajando-con-1millon-de-registros-con-java-stream/">Trabajando con 1 millón de registros con Java Stream</a><li><a href="/posts/disenando-microservicios-con-ddd/">Diseñando Microservicios con Domain Driven Design y NestJS</a><li><a href="/posts/alto-rendimiento-con-cqrs-eventos-en-nestjs/">CQRS en Soluciones de Alto Rendimiento con Nestjs</a></ul></div><div id="access-tags"><div class="panel-heading">Etiquetas populares</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/typescript/">typescript</a> <a class="post-tag" href="/tags/nestjs/">nestjs</a> <a class="post-tag" href="/tags/arquitectura/">arquitectura</a> <a class="post-tag" href="/tags/hexagonal/">hexagonal</a> <a class="post-tag" href="/tags/javascript/">javascript</a> <a class="post-tag" href="/tags/frontend/">frontend</a> <a class="post-tag" href="/tags/java/">Java</a> <a class="post-tag" href="/tags/microservicios/">microservicios,</a> <a class="post-tag" href="/tags/typescript/">Typescript</a> <a class="post-tag" href="/tags/architecture/">Architecture</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contenido</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Lecturas adicionales</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/resena-del-libro-enterprise-integration-patterns/"><div class="card-body"> <em class="small" data-ts="1739854800" data-df="YYYY-MM-DD" > 2025-02-18 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Reseña del Libro Enterprise Integration Patterns</h3><div class="text-muted small"><p> Resumen General Enterprise Integration Patterns: Designing, Building, and Deploying Messaging Solutions es un libro escrito en 2003 por Gregor Hohpe y Bobby Woolf que explora cómo integrar soluci...</p></div></div></a></div><div class="card"> <a href="/posts/que-es-cqrs-y-como-funciona-con-un-ejemplo-practico/"><div class="card-body"> <em class="small" data-ts="1738645200" data-df="YYYY-MM-DD" > 2025-02-04 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>¿Qué es CQRS y cómo funciona? Con un ejemplo práctico.</h3><div class="text-muted small"><p> ¿Qué es CQRS y qué problema soluciona? CQRS (Command Query Responsibility Segregation) es un patrón arquitectónico que separa las operaciones de lectura y escritura en una aplicación. En lugar d...</p></div></div></a></div><div class="card"> <a href="/posts/que-es-y-como-funciona-el-event-sourcing-con-un-ejemplo-practico/"><div class="card-body"> <em class="small" data-ts="1738040400" data-df="YYYY-MM-DD" > 2025-01-28 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>¿Qué es y cómo funciona el Event Sourcing con un ejemplo práctico?</h3><div class="text-muted small"><p> ¿Qué es Event Sourcing? Event Sourcing es un patrón de arquitectura de software que trata cada cambio en el estado de una aplicación como un evento. En lugar de almacenar el estado actual de un ...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="//posts/microservicios-1-construyendo-aplicaciones-escalables-y-mantenibles/" class="btn btn-outline-primary" prompt="Anterior"><p>MicroServicios 1 Construyendo aplicaciones escalables y mantenibles</p></a> <a href="//posts/comunicaci%C3%B3n-entre-microservicios/" class="btn btn-outline-primary" prompt="Nuevo"><p>Microservicios 3 Comunicación entre microservicios</p></a></div></div></div><footer class="row pl-3 pr-3"><div class="col-12 d-flex justify-content-between align-items-center text-muted pl-0 pr-0"><div class="footer-left"><p class="mb-0"> © 2025 <a href="https://github.com/nullpointer-excelsior">Benjamin</a>. <span data-toggle="tooltip" data-placement="top" title="Salvo que se indique explícitamente, las entradas de este blog están licenciadas bajo la Creative Commons Attribution 4.0 International (CC BY 4.0) License por el autor.">Algunos derechos reservados.</span></p></div><div class="footer-right"><p class="mb-0"> Hecho con <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> usando el tema <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> .</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Etiquetas populares</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/typescript/">typescript</a> <a class="post-tag" href="/tags/nestjs/">nestjs</a> <a class="post-tag" href="/tags/arquitectura/">arquitectura</a> <a class="post-tag" href="/tags/hexagonal/">hexagonal</a> <a class="post-tag" href="/tags/javascript/">javascript</a> <a class="post-tag" href="/tags/frontend/">frontend</a> <a class="post-tag" href="/tags/java/">Java</a> <a class="post-tag" href="/tags/microservicios/">microservicios,</a> <a class="post-tag" href="/tags/typescript/">Typescript</a> <a class="post-tag" href="/tags/architecture/">Architecture</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">¡Oops! No se encuentran resultados.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/es.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/unregister.js"></script>
