<!DOCTYPE html><html lang="es-ES" data-mode="dark" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="Creando queries dinámicas con Typeorm para flojear más. Quiero decir hacer menos código" /><meta name="author" content="Benjamin" /><meta property="og:locale" content="es_ES" /><meta name="description" content="Creando queries dinámicas con Typeorm para flojear más. Quiero decir hacer menos código" /><meta property="og:description" content="Creando queries dinámicas con Typeorm para flojear más. Quiero decir hacer menos código" /><link rel="canonical" href="https://nullpointer-excelsior.github.io/posts/creando-queries-dinamicas-con-typeorm/" /><meta property="og:url" content="https://nullpointer-excelsior.github.io/posts/creando-queries-dinamicas-con-typeorm/" /><meta property="og:site_name" content="Nullpointer Excelsior" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-08-03T06:10:00-04:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Creando queries dinámicas con Typeorm para flojear más. Quiero decir hacer menos código" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Benjamin"},"dateModified":"2022-08-08T14:07:49-04:00","datePublished":"2022-08-03T06:10:00-04:00","description":"Creando queries dinámicas con Typeorm para flojear más. Quiero decir hacer menos código","headline":"Creando queries dinámicas con Typeorm para flojear más. Quiero decir hacer menos código","mainEntityOfPage":{"@type":"WebPage","@id":"https://nullpointer-excelsior.github.io/posts/creando-queries-dinamicas-con-typeorm/"},"url":"https://nullpointer-excelsior.github.io/posts/creando-queries-dinamicas-con-typeorm/"}</script><title>Creando queries dinámicas con Typeorm para flojear más. Quiero decir hacer menos código | Nullpointer Excelsior</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Nullpointer Excelsior"><meta name="application-name" content="Nullpointer Excelsior"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" class="mx-auto"> <img src="/assets/img/avatar.webp" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Nullpointer Excelsior</a></div><div class="site-subtitle font-italic">Ingeniería de software aplicada</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>INICIO</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORÍAS</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>ETIQUETAS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVO</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ACERCA DE</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <a href="https://github.com/nullpointer-excelsior" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a></div></div><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4"> <span id="breadcrumb"> <span> <a href="/"> Inicio </a> </span> <span>Creando queries dinámicas con Typeorm para flojear más. Quiero decir hacer menos código</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Entrada</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Buscar..."> </span> <span id="search-cancel" >Cancelar</span></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container pl-xl-4 pr-xl-4"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4"><div class="post pl-1 pr-1 pl-md-2 pr-md-2"><h1 data-toc-skip>Creando queries dinámicas con Typeorm para flojear más. Quiero decir hacer menos código</h1><div class="post-meta text-muted"> <span> Publicado <em class="" data-ts="1659521400" data-df="YYYY-MM-DD" data-toggle="tooltip" data-placement="bottom"> 2022-08-03 </em> </span> <span> Actualizado <em class="" data-ts="1659982069" data-df="YYYY-MM-DD" data-toggle="tooltip" data-placement="bottom"> 2022-08-08 </em> </span><div class="d-flex justify-content-between"> <span> Por <em> Benjamin </em> </span><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1842 palabras"> <em>10 min</em> de lectura</span></div></div></div><div class="post-content"><h1 id="creando-queries-dinámicas-con-typeorm-para-flojear-más-quiero-decir-hacer-menos-código">Creando queries dinámicas con Typeorm para flojear más. Quiero decir hacer menos código</h1><p>Me encanta Typeorm su query builder permite crear complejas queries SQL al más estilo fluent API por abajo una implementación impecable de builder y otras patrañas. Vamos a un paso más adelante y crearemos una API con filtro dinámico donde la aplicación cliente pueda filtrar por el criterio o propiedades que le de la gana. Esto es bastante útil cuando NO quieres emplear un montón de condicionales Ifs, o quieres reutilizar alguna condicional en otra entidad.</p><h2 id="vamos-al-código-no-más-palabras-que-se-las-lleva-el-viento"><span class="mr-2">Vamos al código no más palabras que se las lleva el viento</span><a href="#vamos-al-código-no-más-palabras-que-se-las-lleva-el-viento" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Lo primero será definir nuestra arquitectura, así de pro master hacker de nasa. La entidad a modo de prueba es Movement (robada de un proyecto) la cual representa movimientos de bodega imagínense que tienen miles propiedades para filtrar no coloco más por la flojera</p><div class="language-typescript highlighter-rouge"><div class="code-header"> <span data-label-text="TypeScript"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="¡Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
</pre><td class="rouge-code"><pre>
<span class="p">@</span><span class="nd">Entity</span><span class="p">(</span><span class="dl">"</span><span class="s2">movement</span><span class="dl">"</span><span class="p">)</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">Movement</span> <span class="p">{</span>
  <span class="p">@</span><span class="nd">PrimaryGeneratedColumn</span><span class="p">(</span><span class="dl">"</span><span class="s2">increment</span><span class="dl">"</span><span class="p">,</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="dl">"</span><span class="s2">integer</span><span class="dl">"</span><span class="p">,</span> <span class="na">name</span><span class="p">:</span> <span class="dl">"</span><span class="s2">movement_id</span><span class="dl">"</span> <span class="p">})</span>
  <span class="nx">movementId</span><span class="p">:</span> <span class="kr">number</span><span class="p">;</span>

  <span class="p">@</span><span class="nd">Column</span><span class="p">(</span><span class="dl">"</span><span class="s2">character varying</span><span class="dl">"</span><span class="p">,</span> <span class="p">{</span> <span class="na">name</span><span class="p">:</span> <span class="dl">"</span><span class="s2">sku</span><span class="dl">"</span><span class="p">,</span> <span class="na">default</span><span class="p">:</span> <span class="kc">null</span> <span class="p">})</span>
  <span class="nx">sku</span><span class="p">:</span> <span class="kr">string</span><span class="p">;</span>

  <span class="p">@</span><span class="nd">Column</span><span class="p">(</span><span class="dl">"</span><span class="s2">character varying</span><span class="dl">"</span><span class="p">,</span> <span class="p">{</span> <span class="na">name</span><span class="p">:</span> <span class="dl">"</span><span class="s2">description</span><span class="dl">"</span><span class="p">,</span> <span class="na">default</span><span class="p">:</span> <span class="dl">""</span> <span class="p">})</span>
  <span class="nx">description</span><span class="p">:</span> <span class="kr">string</span><span class="p">;</span>

  <span class="p">@</span><span class="nd">Column</span><span class="p">(</span><span class="dl">"</span><span class="s2">integer</span><span class="dl">"</span><span class="p">,</span> <span class="p">{</span> <span class="na">name</span><span class="p">:</span> <span class="dl">"</span><span class="s2">qty</span><span class="dl">"</span><span class="p">,</span> <span class="na">default</span><span class="p">:</span> <span class="mi">0</span> <span class="p">})</span>
  <span class="nx">qty</span><span class="p">:</span> <span class="kr">number</span><span class="p">;</span>

  <span class="p">@</span><span class="nd">CreateDateColumn</span><span class="p">({</span> <span class="na">type</span><span class="p">:</span> <span class="dl">"</span><span class="s2">timestamptz</span><span class="dl">"</span><span class="p">,</span> <span class="na">name</span><span class="p">:</span> <span class="dl">"</span><span class="s2">created_at</span><span class="dl">"</span> <span class="p">})</span>
  <span class="nx">createdAt</span><span class="p">:</span> <span class="nb">Date</span><span class="p">;</span>

  <span class="p">@</span><span class="nd">Column</span><span class="p">({</span> <span class="na">name</span><span class="p">:</span> <span class="dl">"</span><span class="s2">warehouse_id</span><span class="dl">"</span> <span class="p">})</span>
  <span class="nx">warehouseId</span><span class="p">:</span> <span class="kr">number</span><span class="p">;</span>

  <span class="p">@</span><span class="nd">ManyToOne</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="nx">Warehouse</span><span class="p">,</span> <span class="p">(</span><span class="nx">warehouse</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">warehouse</span><span class="p">.</span><span class="nx">warehouseId</span><span class="p">)</span>
  <span class="p">@</span><span class="nd">JoinColumn</span><span class="p">([{</span> <span class="na">name</span><span class="p">:</span> <span class="dl">"</span><span class="s2">warehouse_id</span><span class="dl">"</span><span class="p">,</span> <span class="na">referencedColumnName</span><span class="p">:</span> <span class="dl">"</span><span class="s2">warehouseId</span><span class="dl">"</span> <span class="p">}])</span>
  <span class="nx">warehouse</span><span class="p">:</span> <span class="nx">Warehouse</span><span class="p">;</span>

  <span class="p">@</span><span class="nd">ManyToOne</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="nx">Reason</span><span class="p">,</span> <span class="p">(</span><span class="nx">reason</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">reason</span><span class="p">.</span><span class="nx">reasonId</span><span class="p">)</span>
  <span class="p">@</span><span class="nd">JoinColumn</span><span class="p">([{</span> <span class="na">name</span><span class="p">:</span> <span class="dl">"</span><span class="s2">reason_id</span><span class="dl">"</span><span class="p">,</span> <span class="na">referencedColumnName</span><span class="p">:</span> <span class="dl">"</span><span class="s2">reasonId</span><span class="dl">"</span> <span class="p">}])</span>
  <span class="nx">reason</span><span class="p">:</span> <span class="nx">Reason</span><span class="p">;</span>

  <span class="p">@</span><span class="nd">Column</span><span class="p">({</span> <span class="na">name</span><span class="p">:</span> <span class="dl">"</span><span class="s2">reason_id</span><span class="dl">"</span> <span class="p">})</span>
  <span class="nx">reasonId</span><span class="p">:</span> <span class="kr">number</span><span class="p">;</span>

  <span class="p">@</span><span class="nd">Column</span><span class="p">({</span> <span class="na">name</span><span class="p">:</span> <span class="dl">"</span><span class="s2">user_id</span><span class="dl">"</span> <span class="p">})</span>
  <span class="nx">userId</span><span class="p">:</span> <span class="kr">number</span><span class="p">;</span>

  <span class="p">@</span><span class="nd">ManyToOne</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="nx">User</span><span class="p">,</span> <span class="nx">user</span> <span class="o">=&gt;</span> <span class="nx">user</span><span class="p">.</span><span class="nx">userId</span><span class="p">)</span>
  <span class="p">@</span><span class="nd">JoinColumn</span><span class="p">([{</span> <span class="na">name</span><span class="p">:</span> <span class="dl">"</span><span class="s2">user_id</span><span class="dl">"</span><span class="p">,</span> <span class="na">referencedColumnName</span><span class="p">:</span> <span class="dl">"</span><span class="s2">userId</span><span class="dl">"</span> <span class="p">}])</span>
  <span class="nx">user</span><span class="p">:</span> <span class="nx">User</span><span class="p">;</span>

  <span class="p">@</span><span class="nd">ManyToOne</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="nx">Detail</span><span class="p">,</span> <span class="nx">detail</span> <span class="o">=&gt;</span> <span class="nx">detail</span><span class="p">.</span><span class="nx">movement</span><span class="p">,</span> <span class="p">{</span> <span class="na">cascade</span><span class="p">:</span> <span class="kc">true</span> <span class="p">})</span>
  <span class="p">@</span><span class="nd">JoinColumn</span><span class="p">({</span> <span class="na">name</span><span class="p">:</span> <span class="dl">"</span><span class="s2">detail_id</span><span class="dl">"</span><span class="p">})</span>
  <span class="nx">detail</span><span class="p">:</span> <span class="nx">Detail</span><span class="p">;</span>
<span class="p">}</span>

</pre></table></code></div></div><h2 id="la-arquitectura-de-nuestro-hack"><span class="mr-2">La Arquitectura de nuestro hack</span><a href="#la-arquitectura-de-nuestro-hack" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Ahora definimos nuestra interfaz Filter en la cual pondremos las propiedades disponibles a filtrar la estructura sería clave y valor de entrada para aplicar un filtro.</p><div class="language-typescript highlighter-rouge"><div class="code-header"> <span data-label-text="TypeScript"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="¡Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre>
<span class="k">export</span> <span class="kr">interface</span> <span class="nx">Filter</span> <span class="p">{</span>
    <span class="p">[</span><span class="nx">x</span><span class="p">:</span><span class="kr">string</span><span class="p">]:</span> <span class="kr">any</span><span class="p">;</span>
<span class="p">}</span>

</pre></table></code></div></div><p>Nuestra segunda definición es una Condición la cual la representaremos mediante una función usando type en vez de interface. Esta función recibe un SelectQueryBuilder objeto propio de Typeorm que se encarga de construir queries y un segundo parámetro que representa la condición de filtrado.</p><div class="language-typescript highlighter-rouge"><div class="code-header"> <span data-label-text="TypeScript"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="¡Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>
<span class="k">export</span> <span class="kd">type</span> <span class="nx">Condition</span><span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;</span> <span class="o">=</span> <span class="p">(</span><span class="nx">qb</span><span class="p">:</span> <span class="nx">SelectQueryBuilder</span><span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;</span><span class="p">,</span> <span class="nx">filterValue</span><span class="p">:</span> <span class="kr">any</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">SelectQueryBuilder</span><span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;</span><span class="p">;</span>

</pre></table></code></div></div><p>Ahora definiremos un tipo para el objeto que contendrá las condiciones este objeto implementara una estrategia de “clave” o nombre del filtro y su condición. Notese que la interfaz Filter y Conditions comparten la misma estructura. noten la magia de typescript ambas formas son igual de válidas.</p><div class="language-typescript highlighter-rouge"><div class="code-header"> <span data-label-text="TypeScript"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="¡Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>
<span class="k">export</span> <span class="kd">type</span> <span class="nx">Conditions</span><span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;</span> <span class="o">=</span> <span class="nb">Record</span><span class="o">&lt;</span><span class="kr">string</span><span class="p">,</span> <span class="nx">Condition</span><span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;&gt;</span><span class="p">;</span>

</pre></table></code></div></div><p>Implementaremos el filtro deseado para nuestra entidad. Pondremos solo estas 3 propiedades a modo de ejemplo</p><div class="language-typescript highlighter-rouge"><div class="code-header"> <span data-label-text="TypeScript"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="¡Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre>
<span class="k">export</span> <span class="kr">interface</span> <span class="nx">MovementFilter</span> <span class="kd">extends</span> <span class="nx">Filter</span> <span class="p">{</span>
    <span class="nl">sku</span><span class="p">:</span> <span class="kr">number</span><span class="p">;</span>
    <span class="nl">qty</span><span class="p">:</span> <span class="kr">number</span><span class="p">;</span>
    <span class="nl">warehouseId</span><span class="p">:</span> <span class="kr">number</span><span class="p">;</span>
<span class="p">}</span>

</pre></table></code></div></div><p>Y ahora se viene una de las partes interesantes del post. implementaremos una condición por la propiedad SKU o Stock Keeping Unit para los bilingües esto a modo de ejemplo.</p><div class="language-typescript highlighter-rouge"><div class="code-header"> <span data-label-text="TypeScript"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="¡Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre>
<span class="kd">const</span> <span class="nx">movementConditions</span><span class="p">:</span> <span class="nx">Conditions</span><span class="o">&lt;</span><span class="nx">Movement</span><span class="o">&gt;</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">sku</span><span class="p">:</span> <span class="p">(</span><span class="na">qb</span><span class="p">:</span> <span class="nx">SelectQueryBuilder</span><span class="o">&lt;</span><span class="nx">Movement</span><span class="o">&gt;</span><span class="p">,</span> <span class="na">sku</span><span class="p">:</span> <span class="kr">number</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">qb</span><span class="p">.</span><span class="nx">andWhere</span><span class="p">(</span><span class="dl">'</span><span class="s1">m.sku = :sku</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span> <span class="dl">'</span><span class="s1">sku</span><span class="dl">'</span><span class="p">:</span> <span class="nx">sku</span> <span class="p">})</span>
<span class="p">}</span>

</pre></table></code></div></div><p>Para entender esta lógica solo debemos poner atención a la condición “m.sku = : sku”, ya que se preguntaran ¿de dónde diablos sale esa “m”? Pues bien cuando definimos una QueryBuilder con Typeorm podemos definir alias entonces “m” será el alias para la entidad Movement, ya que nuestra query base sería la siguiente:</p><div class="language-typescript highlighter-rouge"><div class="code-header"> <span data-label-text="TypeScript"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="¡Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre>
<span class="kd">const</span> <span class="nx">qb</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">repository</span><span class="p">.</span><span class="nx">createQueryBuilder</span><span class="p">(</span><span class="dl">'</span><span class="s1">m</span><span class="dl">'</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">innerJoin</span><span class="p">(</span><span class="dl">'</span><span class="s1">m.detail</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">detail</span><span class="dl">'</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">innerJoin</span><span class="p">(</span><span class="dl">'</span><span class="s1">m.warehouse</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">warehouse</span><span class="dl">'</span><span class="p">)</span>

</pre></table></code></div></div><p>Asi que ven la maldita “m”.Muy bien ahora que entendemos la condición construida en la SelectQueryBuilder vemos que lo único que hace esta función de tipo Condition<ENTITY_TYPE> es recibir un SelectQueryBuilder construir la condición y agregar el valor como parámetro de la query y finalmente devolver el nuevo SelectQueryBuilder. Finalmente nuestro objeto conditions quedará de la siguiente forma:</ENTITY_TYPE></p><div class="language-typescript highlighter-rouge"><div class="code-header"> <span data-label-text="TypeScript"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="¡Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre>
<span class="kd">const</span> <span class="nx">movementConditions</span><span class="p">:</span> <span class="nx">Conditions</span><span class="o">&lt;</span><span class="nx">Movement</span><span class="o">&gt;</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">sku</span><span class="p">:</span> <span class="p">(</span><span class="na">qb</span><span class="p">:</span> <span class="nx">SelectQueryBuilder</span><span class="o">&lt;</span><span class="nx">Movement</span><span class="o">&gt;</span><span class="p">,</span> <span class="na">sku</span><span class="p">:</span> <span class="kr">string</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">qb</span><span class="p">.</span><span class="nx">andWhere</span><span class="p">(</span><span class="dl">'</span><span class="s1">m.sku = :sku</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span> <span class="dl">'</span><span class="s1">sku</span><span class="dl">'</span><span class="p">:</span> <span class="nx">sku</span> <span class="p">}),</span>
    <span class="na">qty</span><span class="p">:</span> <span class="p">(</span><span class="na">qb</span><span class="p">:</span> <span class="nx">SelectQueryBuilder</span><span class="o">&lt;</span><span class="nx">Movement</span><span class="o">&gt;</span><span class="p">,</span> <span class="na">qty</span><span class="p">:</span> <span class="kr">number</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">qb</span><span class="p">.</span><span class="nx">andWhere</span><span class="p">(</span><span class="dl">'</span><span class="s1">m.qty = :qty</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span> <span class="dl">'</span><span class="s1">qty</span><span class="dl">'</span><span class="p">:</span> <span class="nx">qty</span> <span class="p">}),</span>
    <span class="na">warehouseId</span><span class="p">:</span> <span class="p">(</span><span class="na">qb</span><span class="p">:</span> <span class="nx">SelectQueryBuilder</span><span class="o">&lt;</span><span class="nx">Movement</span><span class="o">&gt;</span><span class="p">,</span> <span class="na">id</span><span class="p">:</span> <span class="kr">number</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">qb</span><span class="p">.</span><span class="nx">andWhere</span><span class="p">(</span><span class="dl">'</span><span class="s1">warehouse.warehouse_id = :id</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span> <span class="dl">'</span><span class="s1">id</span><span class="dl">'</span><span class="p">:</span> <span class="nx">id</span> <span class="p">})</span>
<span class="p">}</span>

</pre></table></code></div></div><p>Un mónton de condiciones XD. Pero ya tenemos la lógica del filtro. Nada tan complicado. Y ahora viene la magia de que filtros aplicaremos. No es ciencia de cohetes ni nada si, pero si para mí la magia es que es lógica puramente funcional, en esta ocación a la casa la orientación a objeto o la programación imperativa XD, ya fuera de bromas este es el código y lo explicaré. esto es poesía a lo ñuñoino.</p><h2 id="parece-enredado-pero-a-la-m-explicación-es-ahora"><span class="mr-2">parece enredado pero a la m<em>**</em> explicación es ahora</span><a href="#parece-enredado-pero-a-la-m-explicación-es-ahora" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Nuestra magia empieza con la función build mostrada. Esta recibe un objeto queryBuilderBase: SelectQueryBuilder,(typeorm object)y un objeto conditions: Conditions<ENTITY_TYPE> El cuál habíamos hablado previamente Esta función la explicaré pasa a paso papitos</ENTITY_TYPE></p><div class="language-typescript highlighter-rouge"><div class="code-header"> <span data-label-text="TypeScript"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="¡Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre>
<span class="kd">function</span>  <span class="nx">build</span><span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;</span><span class="p">(</span><span class="nx">queryBuilderBase</span><span class="p">:</span> <span class="nx">SelectQueryBuilder</span><span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;</span><span class="p">,</span> <span class="nx">conditions</span><span class="p">:</span> <span class="nx">Conditions</span><span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;</span><span class="p">,</span> <span class="nx">filter</span><span class="p">:</span> <span class="nx">Filter</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// filter conditions not undefined and reduce to final QueryBuilder</span>
    <span class="kd">const</span> <span class="nx">query</span><span class="p">:</span> <span class="nx">SelectQueryBuilder</span><span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;</span> <span class="o">=</span> <span class="nb">Object</span>
        <span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">filter</span><span class="p">)</span> <span class="c1">//get keys from filter</span>
        <span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">key</span> <span class="o">=&gt;</span> <span class="nx">filter</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="c1">// removing undefined filter values</span>
        <span class="p">.</span><span class="nx">reduce</span><span class="p">((</span><span class="nx">prev</span><span class="p">:</span> <span class="nx">SelectQueryBuilder</span><span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;</span><span class="p">,</span> <span class="nx">curr</span><span class="p">:</span> <span class="kr">string</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
            <span class="kd">const</span> <span class="nx">fn</span> <span class="o">=</span> <span class="nx">conditions</span><span class="p">[</span><span class="nx">curr</span><span class="p">]</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">fn</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nx">fn</span><span class="p">(</span><span class="nx">prev</span><span class="p">,</span> <span class="nx">filter</span><span class="p">[</span><span class="nx">curr</span><span class="p">])</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="nx">prev</span>
        <span class="p">},</span> <span class="nx">queryBuilderBase</span><span class="p">)</span> <span class="c1">// reducing to a SelectQueryBuilder with all conditions</span>
    
    <span class="k">return</span> <span class="nx">query</span>

<span class="p">}</span>

</pre></table></code></div></div><p>Nos ayudamos de Object y su función keys que si le pasamos un objeto nos retorna sus keys entonces le pasamos nuestro objeto de tipo Filter para que nos retorne las keys del filtro que queremos aplicar, Muy bien como este ciudadano nos devuelve un arreglo de keys ahora le vamos a aplicar un filter() para eliminar los valores de tipo undefined al filtro aplicado o sea los valores que no hay que filtrar porque no tienen un valor definido</p><div class="language-typescript highlighter-rouge"><div class="code-header"> <span data-label-text="TypeScript"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="¡Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre>
<span class="nb">Object</span>
    <span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">filter</span><span class="p">)</span> <span class="c1">//get keys from filter</span>
    <span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">key</span> <span class="o">=&gt;</span> <span class="nx">filter</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="c1">// removing undefined filter values</span>

</pre></table></code></div></div><p>Ahora usamos la función reduce() que muchos la ignoran como a la fea del baile, pero tiene sus gracias o si no pregúntele a redux y esas patrañas</p><div class="language-typescript highlighter-rouge"><div class="code-header"> <span data-label-text="TypeScript"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="¡Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre>
<span class="p">.</span><span class="nx">reduce</span><span class="p">((</span><span class="nx">prev</span><span class="p">:</span> <span class="nx">SelectQueryBuilder</span><span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;</span><span class="p">,</span> <span class="nx">curr</span><span class="p">:</span> <span class="kr">string</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">fn</span> <span class="o">=</span> <span class="nx">conditions</span><span class="p">[</span><span class="nx">curr</span><span class="p">]</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">fn</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">fn</span><span class="p">(</span><span class="nx">prev</span><span class="p">,</span> <span class="nx">filter</span><span class="p">[</span><span class="nx">curr</span><span class="p">])</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">prev</span>
<span class="p">},</span> <span class="nx">queryBuilderBase</span><span class="p">)</span> 

</pre></table></code></div></div><p>Como aporta reduce a nuestro súper filtro dinámico, bueno reduce() funciona dándole como parámetros una función con un valor previo y un valor current que sería llamado como actual entonces con esos 2 valores debes devolver algo lo que tú desees una suma una resta, una comparación de objetos o lo que se te dé la gana entonces esta operación será una iteración sobre los datos o arreglo que tengas. Por último hay un tercer parámetro que es el valor inicial en nuestro caso sería nuestra query base.</p><p>Explicado esto fíjense en que recibimos un SelectQueryBuilder entonces por cada key de las condiciones filtradas y válidas preguntamos por su condición del objeto Conditions y la si existe ejecutamos la condición que devuelve un nuevo SelectQueryBuilder y la devolvemos entonces el objeto estará con los nuevos filtro y condiciones</p><div class="language-typescript highlighter-rouge"><div class="code-header"> <span data-label-text="TypeScript"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="¡Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="cm">/**
 * creamos la variable fn que es la que aplica la funcion de la condicion recordemos que curr es la key del filtro entonces si exite el filtro aplicamos la funcion de creacion de SelectQueryBuilder pasanodel el valor del filtro
 **/</span>

<span class="kd">const</span> <span class="nx">fn</span> <span class="o">=</span> <span class="nx">conditions</span><span class="p">[</span><span class="nx">curr</span><span class="p">]</span>
<span class="k">if</span> <span class="p">(</span><span class="nx">fn</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">fn</span><span class="p">(</span><span class="nx">prev</span><span class="p">,</span> <span class="nx">filter</span><span class="p">[</span><span class="nx">curr</span><span class="p">])</span>
<span class="p">}</span>

</pre></table></code></div></div><p>Ahora creamos una clase con un método estático para poder hacer uso de nuestra utilidad y adjuntamos la estructura de Conditions</p><div class="language-typescript highlighter-rouge"><div class="code-header"> <span data-label-text="TypeScript"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="¡Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
</pre><td class="rouge-code"><pre>
<span class="k">import</span> <span class="p">{</span> <span class="nx">SelectQueryBuilder</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">typeorm</span><span class="dl">"</span><span class="p">;</span>
<span class="cm">/**
 * Las interfaces que definan la estructura de un filtro para una query deben heredar de esta interface
 */</span>
<span class="k">export</span> <span class="kr">interface</span> <span class="nx">Filter</span> <span class="p">{</span>
    <span class="p">[</span><span class="nx">x</span><span class="p">:</span><span class="kr">string</span><span class="p">]:</span> <span class="kr">any</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**
 * Esta funcion recibe un SelectQueryBuilder&lt;T&gt; y un valor de filtro para ser aplicado en el objeto SelectQueryBuilder&lt;T&gt;
 */</span>
<span class="k">export</span> <span class="kd">type</span> <span class="nx">Condition</span><span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;</span> <span class="o">=</span> <span class="p">(</span><span class="nx">qb</span><span class="p">:</span> <span class="nx">SelectQueryBuilder</span><span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;</span><span class="p">,</span> <span class="nx">filterValue</span><span class="p">:</span> <span class="kr">any</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">SelectQueryBuilder</span><span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;</span><span class="p">;</span>
<span class="cm">/**
 * Representa un objeto clave Condicion donde la clave es el nombre del filtro
 */</span>
<span class="k">export</span> <span class="kd">type</span> <span class="nx">Conditions</span><span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;</span> <span class="o">=</span> <span class="nb">Record</span><span class="o">&lt;</span><span class="kr">string</span><span class="p">,</span> <span class="nx">Condition</span><span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;&gt;</span><span class="p">;</span>

<span class="cm">/**
 * Clase con metodos de ayuda para crear Queries sobre la librería Typeorm 
 */</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">DynamicQueryBuilder</span> <span class="p">{</span>
    
    <span class="cm">/**
     * Construye una nueva query a partir de una query base una serie de condiciones, un filtro con los valores 
     * y un paginado opcional.
     * @param queryBuilderBase objeto SelectQueryBuilder&lt;T&gt; el que debe contener la sentenica basica de select * from de acuerdo a typeorm
     * @param conditions objeto clave Condition el cual contendra las condiciones opcionales de busqueda
     * @param filter objeto clave valor que contiene los campos a filtrar y su valor
     * @param page Representa un paginado opcional para las queries
     * @returns 
     */</span>
    <span class="k">static</span> <span class="nx">build</span><span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;</span><span class="p">(</span><span class="nx">queryBuilderBase</span><span class="p">:</span> <span class="nx">SelectQueryBuilder</span><span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;</span><span class="p">,</span> <span class="nx">conditions</span><span class="p">:</span> <span class="nx">Conditions</span><span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;</span><span class="p">,</span> <span class="nx">filter</span><span class="p">:</span> <span class="nx">Filter</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// filter conditions not undefined and reduce to final QueryBuilder</span>
        <span class="kd">const</span> <span class="nx">query</span><span class="p">:</span> <span class="nx">SelectQueryBuilder</span><span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;</span> <span class="o">=</span> <span class="nb">Object</span>
            <span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">filter</span><span class="p">)</span> <span class="c1">//get keys from filter</span>
            <span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">key</span> <span class="o">=&gt;</span> <span class="nx">filter</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="c1">// removing undefined filter values</span>
            <span class="p">.</span><span class="nx">reduce</span><span class="p">((</span><span class="nx">prev</span><span class="p">:</span> <span class="nx">SelectQueryBuilder</span><span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;</span><span class="p">,</span> <span class="nx">curr</span><span class="p">:</span> <span class="kr">string</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
                <span class="kd">const</span> <span class="nx">fn</span> <span class="o">=</span> <span class="nx">conditions</span><span class="p">[</span><span class="nx">curr</span><span class="p">]</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">fn</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">return</span> <span class="nx">fn</span><span class="p">(</span><span class="nx">prev</span><span class="p">,</span> <span class="nx">filter</span><span class="p">[</span><span class="nx">curr</span><span class="p">])</span>
                <span class="p">}</span>
                <span class="k">return</span> <span class="nx">prev</span>
            <span class="p">},</span> <span class="nx">queryBuilderBase</span><span class="p">)</span> <span class="c1">// reducing to a SelectQueryBuilder with all conditions</span>
 
        <span class="k">return</span> <span class="nx">query</span>
    
    <span class="p">}</span>

<span class="p">}</span>

</pre></table></code></div></div><p>Como nuestra función nos devuelve un objeto SelectQueryBuilder podremos agregar algún ordenamiento, límite y offset o condición obligatoria esto va a depender de nuestros casos de uso.Bueno vamos a juntar todo en un servicio con Nestjs que haga las consultas dinámicas</p><div class="language-typescript highlighter-rouge"><div class="code-header"> <span data-label-text="TypeScript"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="¡Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre><td class="rouge-code"><pre>
<span class="p">@</span><span class="nd">Injectable</span><span class="p">()</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">MovementService</span> <span class="p">{</span>
    <span class="cm">/**
     * Condiciones para el filtro 
     **/</span>
    <span class="k">private</span> <span class="nx">movementConditions</span><span class="p">:</span> <span class="nx">Conditions</span><span class="o">&lt;</span><span class="nx">Movement</span><span class="o">&gt;</span> <span class="o">=</span> <span class="p">{</span>
        <span class="na">sku</span><span class="p">:</span> <span class="p">(</span><span class="na">qb</span><span class="p">:</span> <span class="nx">SelectQueryBuilder</span><span class="o">&lt;</span><span class="nx">Movement</span><span class="o">&gt;</span><span class="p">,</span> <span class="na">sku</span><span class="p">:</span> <span class="kr">string</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">qb</span><span class="p">.</span><span class="nx">andWhere</span><span class="p">(</span><span class="dl">'</span><span class="s1">m.sku = :sku</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span> <span class="dl">'</span><span class="s1">sku</span><span class="dl">'</span><span class="p">:</span> <span class="nx">sku</span> <span class="p">}),</span>
        <span class="na">qty</span><span class="p">:</span> <span class="p">(</span><span class="na">qb</span><span class="p">:</span> <span class="nx">SelectQueryBuilder</span><span class="o">&lt;</span><span class="nx">Movement</span><span class="o">&gt;</span><span class="p">,</span> <span class="na">qty</span><span class="p">:</span> <span class="kr">number</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">qb</span><span class="p">.</span><span class="nx">andWhere</span><span class="p">(</span><span class="dl">'</span><span class="s1">m.qty = :qty</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span> <span class="dl">'</span><span class="s1">qty</span><span class="dl">'</span><span class="p">:</span> <span class="nx">qty</span> <span class="p">}),</span>
        <span class="na">warehouseId</span><span class="p">:</span> <span class="p">(</span><span class="na">qb</span><span class="p">:</span> <span class="nx">SelectQueryBuilder</span><span class="o">&lt;</span><span class="nx">Movement</span><span class="o">&gt;</span><span class="p">,</span> <span class="na">id</span><span class="p">:</span> <span class="kr">number</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">qb</span><span class="p">.</span><span class="nx">andWhere</span><span class="p">(</span><span class="dl">'</span><span class="s1">warehouse.warehouse_id = :id</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span> <span class="dl">'</span><span class="s1">id</span><span class="dl">'</span><span class="p">:</span> <span class="nx">id</span> <span class="p">})</span>
    <span class="p">}</span>

    <span class="kd">constructor</span><span class="p">(</span>
        <span class="p">@</span><span class="nd">InjectRepository</span><span class="p">(</span><span class="nx">Movement</span><span class="p">)</span> <span class="k">private</span> <span class="k">readonly</span> <span class="nx">repository</span><span class="p">:</span> <span class="nx">Repository</span><span class="o">&lt;</span><span class="nx">Movement</span><span class="o">&gt;</span>
    <span class="p">)</span> <span class="p">{</span> <span class="p">}</span>

    <span class="k">async</span> <span class="nx">findByFilter</span><span class="p">(</span><span class="nx">filter</span><span class="p">:</span> <span class="nx">MovementFilter</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// build query base</span>
        <span class="kd">const</span> <span class="nx">qb</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">repository</span><span class="p">.</span><span class="nx">createQueryBuilder</span><span class="p">(</span><span class="dl">'</span><span class="s1">m</span><span class="dl">'</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">innerJoin</span><span class="p">(</span><span class="dl">'</span><span class="s1">m.detail</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">detail</span><span class="dl">'</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">innerJoin</span><span class="p">(</span><span class="dl">'</span><span class="s1">m.warehouse</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">warehouse</span><span class="dl">'</span><span class="p">)</span>
        <span class="c1">// building a dynamic SelectQueryBuilder</span>
        <span class="kd">const</span> <span class="nx">query</span> <span class="o">=</span> <span class="nx">DynamicQueryBuilder</span><span class="p">.</span><span class="nx">build</span><span class="o">&lt;</span><span class="nx">Movement</span><span class="o">&gt;</span><span class="p">(</span><span class="nx">qb</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">movementConditions</span><span class="p">,</span> <span class="nx">filter</span><span class="p">)</span>
        <span class="c1">// aditional conditions if you want  </span>
        <span class="k">return</span> <span class="nx">query</span><span class="p">.</span><span class="nx">getMany</span><span class="p">()</span>

    <span class="p">}</span>

<span class="p">}</span>

</pre></table></code></div></div><div class="language-typescript highlighter-rouge"><div class="code-header"> <span data-label-text="TypeScript"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="¡Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre>
<span class="kd">const</span> <span class="nx">filter</span><span class="p">:</span> <span class="nx">Filter</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">sku</span><span class="p">:</span> <span class="mi">9997687667</span><span class="p">;</span>
    <span class="nl">warehouseId</span><span class="p">:</span> <span class="mi">230</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">const</span> <span class="nx">movements</span> <span class="o">=</span> <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">movementService</span><span class="p">.</span><span class="nx">findByFilter</span><span class="p">(</span><span class="nx">filter</span><span class="p">)</span>

</pre></table></code></div></div><h2 id="conclusiones"><span class="mr-2">Conclusiones</span><a href="#conclusiones" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Nada de conclusiones acá hay un meme</p><p><img data-src="https://i.ibb.co/6PLpqVQ/meme-Link-id.jpg" alt="meme" data-proofer-ignore></p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='//categories/backend/'>backend</a>, <a href='//categories/orm/'>orm</a>, <a href='//categories/hackcode/'>hackcode</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="//tags/backend/" class="post-tag no-text-decoration" >backend</a> <a href="//tags/typescript/" class="post-tag no-text-decoration" >typescript</a> <a href="//tags/hackcode/" class="post-tag no-text-decoration" >hackcode</a> <a href="//tags/nestjs/" class="post-tag no-text-decoration" >nestjs</a> <a href="//tags/nodejs/" class="post-tag no-text-decoration" >nodejs</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> Esta entrada está licenciada bajo <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> por el autor.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Compartir</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Creando+queries+din%C3%A1micas+con+Typeorm+para+flojear+m%C3%A1s.+Quiero+decir+hacer+menos+c%C3%B3digo+-+Nullpointer+Excelsior&url=https%3A%2F%2Fnullpointer-excelsior.github.io%2Fposts%2Fcreando-queries-dinamicas-con-typeorm%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Creando+queries+din%C3%A1micas+con+Typeorm+para+flojear+m%C3%A1s.+Quiero+decir+hacer+menos+c%C3%B3digo+-+Nullpointer+Excelsior&u=https%3A%2F%2Fnullpointer-excelsior.github.io%2Fposts%2Fcreando-queries-dinamicas-con-typeorm%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Fnullpointer-excelsior.github.io%2Fposts%2Fcreando-queries-dinamicas-con-typeorm%2F&text=Creando+queries+din%C3%A1micas+con+Typeorm+para+flojear+m%C3%A1s.+Quiero+decir+hacer+menos+c%C3%B3digo+-+Nullpointer+Excelsior" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Fnullpointer-excelsior.github.io%2Fposts%2Fcreando-queries-dinamicas-con-typeorm%2F" data-toggle="tooltip" data-placement="top" title="Linkedin" target="_blank" rel="noopener" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copiar enlace" data-title-succeed="¡Enlace copiado!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Actualizado recientemente</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/microservicios-observabilidad-en-microservicios-un-ejemplo-practico-de-trazas-distribuidas/">Microservicios 2 Observabilidad en NestJs, un ejemplo práctico de trazas distribuidas</a><li><a href="/posts/realtime-with-reactive-programming/">Aplicaciones en tiempo real con programación reactiva</a><li><a href="/posts/tranajando-con-1millon-de-registros-con-java-stream/">Trabajando con 1 millón de registros con Java Stream</a><li><a href="/posts/disenando-microservicios-con-ddd/">Diseñando Microservicios con Domain Driven Design y NestJS</a><li><a href="/posts/alto-rendimiento-con-cqrs-eventos-en-nestjs/">CQRS en Soluciones de Alto Rendimiento con Nestjs</a></ul></div><div id="access-tags"><div class="panel-heading">Etiquetas populares</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/typescript/">typescript</a> <a class="post-tag" href="/tags/nestjs/">nestjs</a> <a class="post-tag" href="/tags/arquitectura/">arquitectura</a> <a class="post-tag" href="/tags/hexagonal/">hexagonal</a> <a class="post-tag" href="/tags/javascript/">javascript</a> <a class="post-tag" href="/tags/frontend/">frontend</a> <a class="post-tag" href="/tags/java/">Java</a> <a class="post-tag" href="/tags/microservicios/">microservicios,</a> <a class="post-tag" href="/tags/typescript/">Typescript</a> <a class="post-tag" href="/tags/architecture/">Architecture</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contenido</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Lecturas adicionales</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/implementando-hexagonal-con-nestjs-part1/"><div class="card-body"> <em class="small" data-ts="1666711920" data-df="YYYY-MM-DD" > 2022-10-25 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Arquitectura hexagonal con nestjs Parte I</h3><div class="text-muted small"><p> No voy a profundizar en que es una arquitectura hexagonal, ya que tenemos un montón de recursos que te lo explican de forma detallada, pero ojo que cuando hablamos de este tipo de arquitecturas d...</p></div></div></a></div><div class="card"> <a href="/posts/implementando-hexagonal-con-nestjs-part2/"><div class="card-body"> <em class="small" data-ts="1666798320" data-df="YYYY-MM-DD" > 2022-10-26 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Arquitectura hexagonal Parte II Conectando una clean architecture con Nestjs</h3><div class="text-muted small"><p> La segunda parte de esta serie de arquitectura hexagonal o (clean architecture) profundizaremos como configurar la interacción de un framework con el core de nuestra arquitectura, Nestjs nos ofre...</p></div></div></a></div><div class="card"> <a href="/posts/nestjs-tips-la-versatilidad-de-configuration-module/"><div class="card-body"> <em class="small" data-ts="1666971120" data-df="YYYY-MM-DD" > 2022-10-28 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Nestjs tips La versatilidad de ConfigMdule</h3><div class="text-muted small"><p> El manejo de credenciales y configuraciones en nuestras aplicaciones es generalmente algo indispensable para los distintos escenarios de desarrollo y despliegue. Algo tedioso a veces, pero nuestr...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"><div class="btn btn-outline-primary disabled" prompt="Anterior"><p>-</p></div><a href="//posts/5-Arquitecturas-de-software-para-tigres-del-codigo/" class="btn btn-outline-primary" prompt="Nuevo"><p>5 Arquitecturas de software para tigres del código</p></a></div></div></div><footer class="row pl-3 pr-3"><div class="col-12 d-flex justify-content-between align-items-center text-muted pl-0 pr-0"><div class="footer-left"><p class="mb-0"> © 2025 <a href="https://github.com/nullpointer-excelsior">Benjamin</a>. <span data-toggle="tooltip" data-placement="top" title="Salvo que se indique explícitamente, las entradas de este blog están licenciadas bajo la Creative Commons Attribution 4.0 International (CC BY 4.0) License por el autor.">Algunos derechos reservados.</span></p></div><div class="footer-right"><p class="mb-0"> Hecho con <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> usando el tema <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> .</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Etiquetas populares</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/typescript/">typescript</a> <a class="post-tag" href="/tags/nestjs/">nestjs</a> <a class="post-tag" href="/tags/arquitectura/">arquitectura</a> <a class="post-tag" href="/tags/hexagonal/">hexagonal</a> <a class="post-tag" href="/tags/javascript/">javascript</a> <a class="post-tag" href="/tags/frontend/">frontend</a> <a class="post-tag" href="/tags/java/">Java</a> <a class="post-tag" href="/tags/microservicios/">microservicios,</a> <a class="post-tag" href="/tags/typescript/">Typescript</a> <a class="post-tag" href="/tags/architecture/">Architecture</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">¡Oops! No se encuentran resultados.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/es.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/unregister.js"></script>
